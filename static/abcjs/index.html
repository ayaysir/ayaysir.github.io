<!DOCTYPE HTML>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv="content-type" content="text/html" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <title>abcjs editor</title>

  <link href="https://cdn.jsdelivr.net/npm/abcjs@6.6.0/abcjs-audio.min.css" media="all" rel="stylesheet"
    type="text/css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.5.2/abcjs-basic-min.js" type="text/javascript"></script>
  <style>
    .abcjs-inline-audio {
      max-width: 770px;
    }

    @media print {

      h1,
      p,
      textarea,
      #selection,
      #audio,
      #warnings,
      hr {
        display: none;
      }
    }

    p {
      max-width: 600px;
    }

    body {
      display: flex;
      flex-direction: row;
      gap: 0px;
    }

    #left-area {
      flex: 46;
    }

    #right-area {
      flex: 54;
    }

    #selection pre {
      white-space: pre-wrap;
      word-break: break-word;
      overflow-x: hidden;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
    }

    #warnings {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 10vh;
      overflow-y: auto;
      background: #fff;
      border-top: 1px solid #ccc;
      padding: 8px 12px;
      font-size: 13px;
      z-index: 1000;
    }

    #selection {
      position: fixed;
      bottom: 0vh;
      left: 0;
      right: 0;
      max-height: 10vh;
      overflow-y: auto;
      background: #fff;
      border-top: 1px solid #ccc;
      padding: 8px 12px;
      font-size: 13px;
      z-index: 1000;
    }
  </style>
</head>

<body>


  <div id="left-area">
    <h1>abcjs simple editor v0.1</h1>
    <div id="audio"></div>
    <label><span style="font-size: 10px; font-weight: bold;">Transpose:</span>
      <input id="transpose" data-idx="0" class="transpose-half-steps" type="number" onchange="redraw(this.value);"
        min="-12" max="12" step="1" value="0">
      <button style="width: 30px;" onclick="changeTransposeValue(-1);">-</button>
      <button style="width: 30px;" onclick="changeTransposeValue(1);">+</button>
    </label>
    <div id="paper0" class="paper"></div>
    <div id="paper1" class="paper"></div>
    <div id="paper2" class="paper"></div>
    <div id="paper3" class="paper"></div>

  </div>
  <div id="right-area">
    <button id="copy-with-tag">ÌÉúÍ∑∏Î•º Ìè¨Ìï®ÌïòÏó¨ Î≥µÏÇ¨</button>
    <div id="button-area" class="symbol-buttons"></div>
    <textarea id="abc-editor" name="abc" cols="100" rows="50"></textarea>
    <textarea id="abc-editor-sanitized" style="display:none;"></textarea>
  </div>

  <div id="warnings"></div>
  <div id="selection"></div>
  <script type="text/javascript">
    const initialAbcText = `X: 1
T: Cooley's
M: 4/4
L: 1/8
R: reel
K: Emin
|:D2|EB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|
EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2:|
|:gf|eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|
eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2:|
`;
    const STORAGE_KEY = 'abcjs-editor-content';
    const SYMBOLS = ['ü°á', '‚Ö†', '‚Ö°', '‚Ö¢', '‚Ö£', '‚Ö§', '‚Ö•', '‚Ö¶', '‚Öß', '‚Ö∞', '‚Ö±', '‚Ö≤', '‚Ö≥', '‚Ö¥', '‚Öµ', '‚Ö∂', '‚ìâ', '‚ìà', '‚íπ'];

    function insertAtCursor(textarea, text) {
      textarea.focus();

      // beforeinput Ïù¥Î≤§Ìä∏Î•º ÌÜµÌï¥ Ïã§Ï†ú ÌÇ§Î≥¥Îìú ÏûÖÎ†•Í≥º ÎèôÏùºÌïòÍ≤å Ï≤òÎ¶¨
      const event = new InputEvent('beforeinput', {
        inputType: 'insertText',
        data: text,
        bubbles: true,
        cancelable: true
      });

      if (textarea.dispatchEvent(event)) {
        // execCommandÎäî deprecatedÏù¥ÏßÄÎßå undo stackÏùÑ Ïú†ÏßÄÌïòÎäî Í∞ÄÏû• ÏïàÏ†ïÏ†ÅÏù∏ Î∞©Î≤ï
        document.execCommand('insertText', false, text);
      }

      textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function sanitizeAbcForRender(text) {
      return text
        // Ï§ëÍ∞ÑÏùò Îπà Ï§Ñ(Í≥µÎ∞±Îßå ÏûàÎäî Ï§Ñ Ìè¨Ìï®)ÏùÑ ÌïòÎÇòÏùò Ï§ÑÎ∞îÍøàÏúºÎ°ú Ï∂ïÏÜå
        .replace(/\n\s*\n+/g, '\n')
        // ÎÅùÏóê ÏûàÎäî Í≥µÎ∞± Ï§Ñ(Ìïú Ï§ÑÏù¥Îì† Ïó¨Îü¨ Ï§ÑÏù¥Îì†) Ï†úÍ±∞
        .replace(/\n\s*$/g, '');
    }

    function showToast(message) {
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'toast';
        document.body.appendChild(toast);
      }

      toast.textContent = message;
      toast.classList.add('show');

      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => {
        toast.classList.remove('show');
      }, 1500);
    }

    async function copySanitizedAbcWithTag() {
      const sanitizedTextarea = document.getElementById('abc-editor-sanitized');
      const text = sanitizedTextarea.value || '';
      const wrapped = `<code class="abc">\n${text}\n</code>`;

      await navigator.clipboard.writeText(wrapped);
      showToast('Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§');
    }

    function selectionCallback(abcelem) {
      var note = {};
      for (var key in abcelem) {
        if (abcelem.hasOwnProperty(key) && key !== "abselem")
          note[key] = abcelem[key];
      }
      console.log(abcelem);
      var el = document.getElementById("selection");
      el.innerHTML = `<b>selectionCallback parameter:</b><br><pre>${JSON.stringify(note)}</pre>`;

      var lastClicked = abcelem.midiPitches;
      if (!lastClicked)
        return;
      ABCJS.synth
        .playEvent(lastClicked, abcelem.midiGraceNotePitches, 1000)
        .then(function (response) {
          console.log("note played");
        }).catch(function (error) {
          console.log("error playing note", error);
        });
    }

    let currentVisualObj = null;

    function renderAbcText(abcText, visualTranspose = 0) {
      document.getElementById('paper0').innerHTML = '';
      document.getElementById('audio').innerHTML = '';
      document.getElementById('warnings').innerHTML = '';

      currentVisualObj = ABCJS.renderAbc('paper0', abcText, {
        visualTranspose: visualTranspose,
        generate_warnings: true,
        warnings_id: 'warnings',
        clickListener: selectionCallback
      });

      // ABCJS.renderMidi('audio', abcText, {
      //   displayLoop: true,
      //   displayRestart: true,
      //   displayPlay: true,
      //   displayProgress: true,
      //   displayWarp: true
      // });
      initSynth(currentVisualObj, visualTranspose)
    }

    /// Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ Ï¥àÍ∏∞Ìôî
    function initSynth(visualObjs, transpose = 0) {
      var cursorControl = new CursorControl(`paper0`, null);
      var synthControl = new ABCJS.synth.SynthController();
      var el = document.getElementById(`audio`);
      synthControl.load(el, cursorControl, {
        displayRestart: true,
        displayPlay: true,
        displayProgress: true
      });
      synthControl.disable(true);
      var midiBuffer = new ABCJS.synth.CreateSynth();

      midiBuffer.init({
        visualObj: visualObjs[0],
        options: { responsive: 'resize' }
      }).then(() => {
        if (synthControl) {
          synthControl.setTune(visualObjs[0], false, { midiTranspose: transpose }).catch(error => {
            console.warn("Audio problem:", error);
          });
        }
      }).catch(error => {
        console.warn("Audio problem:", error);
      });
    }

    /// Ïª§ÏÑú Ïù¥Îèô Í¥ÄÎ†® Ìï®Ïàò
    function CursorControl(selector) {
      var self = this;

      self.onStart = function () {
        var svg = document.querySelector("#" + selector + " svg");
        var cursor = document.createElementNS("http://www.w3.org/2000/svg", "line");
        cursor.setAttribute("class", "abcjs-cursor");
        cursor.setAttributeNS(null, 'x1', 0);
        cursor.setAttributeNS(null, 'y1', 0);
        cursor.setAttributeNS(null, 'x2', 0);
        cursor.setAttributeNS(null, 'y2', 0);
        svg.appendChild(cursor);

      };
      self.beatSubdivisions = 2;
      self.onEvent = function (ev) {
        if (ev.measureStart && ev.left === null)
          return; // this was the second part of a tie across a measure line. Just ignore it.

        var lastSelection = document.querySelectorAll("#" + selector + " svg .highlight");
        for (var k = 0; k < lastSelection.length; k++)
          lastSelection[k].classList.remove("highlight");

        for (var i = 0; i < ev.elements.length; i++) {
          var note = ev.elements[i];
          for (var j = 0; j < note.length; j++) {
            note[j].classList.add("highlight");
          }
        }

        var cursor = document.querySelector("#" + selector + " svg .abcjs-cursor");
        if (cursor) {
          cursor.setAttribute("x1", ev.left - 2);
          cursor.setAttribute("x2", ev.left - 2);
          cursor.setAttribute("y1", ev.top);
          cursor.setAttribute("y2", ev.top + ev.height);
        }
      };
      self.onFinished = function () {
        var els = document.querySelectorAll("#" + selector + " svg .highlight");
        for (var i = 0; i < els.length; i++) {
          els[i].classList.remove("highlight");
        }
        var cursor = document.querySelector("#" + selector + " svg .abcjs-cursor");
        if (cursor) {
          cursor.setAttribute("x1", 0);
          cursor.setAttribute("x2", 0);
          cursor.setAttribute("y1", 0);
          cursor.setAttribute("y2", 0);
        }
      };
    }

    function changeTransposeValue(addValue = 1) {
      var selector = document.querySelector(`#transpose`)
      var addValue = parseInt(addValue)
      let oldValue = parseInt(selector.value)
      selector.value = oldValue + addValue
      redraw(selector.value)
    }

    /// TransposedÎêú Í≤ΩÏö∞ ÏïÖÎ≥¥&ÌîåÎ†àÏù¥Ïñ¥ Îã§Ïãú Í∑∏Î¶¨Í∏∞
    function redraw(transposeValue) {
      // re-render visualObj
      const sanitizedTextarea = document.getElementById('abc-editor-sanitized');
      renderAbcText(sanitizedTextarea.value, transposeValue);
    }

    function initEditor() {
      const textarea = document.getElementById('abc-editor');
      const sanitizedTextarea = document.getElementById('abc-editor-sanitized');
      const buttonArea = document.getElementById('button-area');
      buttonArea.innerHTML = '';

      SYMBOLS.forEach(symbol => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = symbol;
        btn.addEventListener('click', () => {
          insertAtCursor(textarea, symbol);
        });
        buttonArea.appendChild(btn);
      });

      const saved = localStorage.getItem(STORAGE_KEY);
      textarea.value = saved !== null ? saved : initialAbcText;
      const initialSanitized = sanitizeAbcForRender(textarea.value);
      sanitizedTextarea.value = initialSanitized;
      renderAbcText(initialSanitized);

      textarea.addEventListener('input', () => {
        const original = textarea.value;
        localStorage.setItem(STORAGE_KEY, original);

        const sanitized = sanitizeAbcForRender(original);
        sanitizedTextarea.value = sanitized;

        renderAbcText(sanitized);
      });

      textarea.addEventListener('keydown', (e) => {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;

        // ÏÑ†ÌÉù ÏòÅÏó≠Ïù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÎèôÏûë Ïú†ÏßÄ
        if (start === end) return;

        let openChar = null;
        let closeChar = null;

        if (e.key === '[') {
          openChar = '[';
          closeChar = ']';
        } else if (e.key === '(') {
          openChar = '(';
          closeChar = ')';
        }

        if (!openChar) return;

        e.preventDefault();

        const selectedText = textarea.value.slice(start, end);
        const wrapped = openChar + selectedText + closeChar;

        textarea.focus();

        // undo/redo Ïä§ÌÉùÏùÑ Ïú†ÏßÄÌïòÍ∏∞ ÏúÑÌï¥ execCommand ÏÇ¨Ïö©
        document.execCommand('insertText', false, wrapped);
      });

      const copyButton = document.getElementById('copy-with-tag');
      copyButton.addEventListener('click', () => {
        copySanitizedAbcWithTag();
      });

      // Îã®Ï∂ïÌÇ§: Ctrl + Shift + C (macOS: Cmd + Shift + C)
      document.addEventListener('keydown', (e) => {
        const isMac = navigator.platform.toUpperCase().includes('MAC');
        const modKey = isMac ? e.metaKey : e.ctrlKey;

        if (modKey && e.shiftKey && e.code === 'KeyC') {
          e.preventDefault();
          copySanitizedAbcWithTag();
        }
      });
    }
    window.addEventListener("load", initEditor, false);
  </script>
</body>

</html>