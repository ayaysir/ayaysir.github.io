---
title: "Swift: iOSì—ì„œ ì»¤ìŠ¤í…€ ì¹´ë©”ë¼ ë§Œë“¤ê¸° (1) - ë¹„ë””ì˜¤ ìº¡ì²˜ ë°©ì‹ í™œìš©"
date: 2023-07-08
categories: 
  - "DevLog"
  - "Swift"
---

## **iOSì—ì„œ ì»¤ìŠ¤í…€ ì¹´ë©”ë¼ ë§Œë“¤ê¸°**

##### **ì›ë¬¸**

- [Making A Custom Camera In iOS](https://medium.com/@barbulescualex/making-a-custom-camera-in-ios-ea44e3087563)

ìš°ë¦¬ëŠ” iOSì—ì„œ ì–´ë–¤ í˜•íƒœë¡œë“  ì»¤ìŠ¤í…€ ì¹´ë©”ë¼ë¥¼ ë´ì™”ìŠµë‹ˆë‹¤ë§Œ, ì–´ë–»ê²Œ ì§ì ‘ ì¹´ë©”ë¼ë¥¼ ì»¤ìŠ¤í…€í•  ìˆ˜ ìˆì„ê¹Œìš”?

ì´ íŠœí† ë¦¬ì–¼ì—ì„œëŠ” ê¸°ë³¸ ì‚¬í•­ì„ ë‹¤ë£¨ë©´ì„œ ë™ì‹œì— ê³ ê¸‰ êµ¬í˜„ ë° ì˜µì…˜ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤. ê³§ ì•Œê²Œ ë˜ê² ì§€ë§Œ iOS ê¸°ê¸°ì—ì„œ ì˜¤ë””ì˜¤/ë¹„ë””ì˜¤ í•˜ë“œì›¨ì–´ ìƒí˜¸ ì‘ìš©ì— ê´€í•œ ì˜µì…˜ì€ ë§ìŠµë‹ˆë‹¤! í•­ìƒ ê·¸ë ‡ë“¯ì´ ì €ëŠ” ë³µì‚¬-ë¶™ì—¬ë„£ê¸°ë¥¼ ìœ„í•œ ì½”ë“œë¥¼ ì œê³µí•˜ëŠ” ê²ƒë³´ë‹¤ ìš°ë¦¬ê°€ í•˜ê³  ìˆëŠ” ì¼ì— ëŒ€í•œ ì§ê´€ë ¥(intuition)ì„ ë°œì „ì‹œí‚¤ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.

iOSì—ì„œ ì¹´ë©”ë¼ ì•±ì„ ë§Œë“œëŠ” ë°©ë²•ì„ ì´ë¯¸ ì•Œê±°ë‚˜ ë” ë§ì€ ë„ì „ì„ ì›í•˜ë‚˜ìš”? í•„í„° êµ¬í˜„ì— ëŒ€í•œ [ê³ ê¸‰ íŠœí† ë¦¬ì–¼ (ì˜ë¬¸)](https://medium.com/@barbulescualex/using-cifilters-metal-to-make-a-custom-camera-in-ios-c76134993316)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

Â 

### **ì‹œì‘ ì½”ë“œ**

[ì˜ˆì œ ì½”ë“œ](https://github.com/barbulescualex/iOSCustomCamera)ì—ì„œ ì½”ë“œë¥¼ í´ë¡ í•˜ê±°ë‚˜ ë‹¤ìš´ë¡œë“œí•œ ë’¤ `Start` í´ë”ì˜ í”„ë¡œì íŠ¸ë¥¼ ì—½ë‹ˆë‹¤.

> ì´ í¬ìŠ¤íŠ¸ì— ë‹¤ë£¨ì§€ ì•Šì€ ê³ë‹¤ë¦¬ ì½”ë“œë“¤ì´ ìˆìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ì˜ˆì œ í”„ë¡œì íŠ¸ì—ì„œ ì‹œì‘í•´ì•¼ ëª¨ë“  ë™ì‘ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.

 ![](/assets/img/wp-content/uploads/2023/07/1_VibmPkvJVzDQJk4bzSgemg.webp)

**(ëª¨ë“  ë‚´ìš©ì€ ì‹¤ì œ ê¸°ê¸°ì—ì„œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.)** ì‹¤í–‰í•´ë³´ë©´ ê±°ì˜ ì§„í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª¨ë“  ë¡œì§ì€ `ViewController.swift`ì—ì„œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. ìº¡ì²˜ ë²„íŠ¼, ì¹´ë©”ë¼ ì „í™˜ ë²„íŠ¼, ë§ˆì§€ë§‰ìœ¼ë¡œ ì°ì€ ì‚¬ì§„ì„ ë‹´ì„ Viewë§Œ ìˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ì•¡ì„¸ìŠ¤ ìš”ì²­ë„ í¬í•¨ì‹œì¼°ìŠµë‹ˆë‹¤. ê±°ë¶€í•˜ë©´ ì•±ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤ ğŸ˜. ë·° ì„¤ì • ë° ì¹´ë©”ë¼ ì¸ì¦ í™•ì¸ì€ ê´€ë ¨ì„±ì´ ë‚®ì€ ì½”ë“œë¡œ ì‘ì—… ê³µê°„ì„ ì–´ì§€ëŸ½íˆì§€ ì•Šê¸° ìœ„í•´ `ViewController+Extras.swift` ë³„ë„ íŒŒì¼ì˜ í´ë˜ìŠ¤ í™•ì¥ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤.

Â 

### **í‘œì¤€ ì»¤ìŠ¤í…€ ì¹´ë©”ë¼ ì„¤ì •**

ì´ì œ `AVFoundation` í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¹´ë©”ë¼ í”¼ë“œë¥¼ ìº¡ì²˜í•˜ê³  í‘œì‹œí•˜ì—¬ ì‚¬ìš©ìê°€ `UIImagePickerViewController`(\*ì•± ë‚´ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ë³¸ ì¹´ë©”ë¼ë¥¼ ì œê³µ)ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ì•± ë‚´ì—ì„œ ì‚¬ì§„ì„ ì°ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

`AVFoundation`ì€ iOSì˜ ëª¨ë“  ì˜¤ë””ì˜¤/ë¹„ì£¼ì–¼ì— ëŒ€í•œ ë†’ì€ ì¶”ìƒí™” ë ˆë²¨ì˜ í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê³¼ì†Œ í‰ê°€í•˜ì§€ ë§ˆì„¸ìš”. (í•©ë¦¬ì ì¸ ë²”ìœ„ ë‚´ì—ì„œ) ë§¤ìš° ê°•ë ¥í•˜ë©° ì›í•˜ëŠ” ëª¨ë“  ìœ ì—°ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.

ìš°ë¦¬ì˜ ê´€ì‹¬ì€ [ì¹´ë©”ë¼ ë° ë¯¸ë””ì–´ ìº¡ì²˜](https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture)ì…ë‹ˆë‹¤.

> `AVFoundation` ìº¡ì²˜ í•˜ìœ„ ì‹œìŠ¤í…œì€ iOS ë° macOSì—ì„œ ë¹„ë””ì˜¤, ì‚¬ì§„ ë° ì˜¤ë””ì˜¤ ìº¡ì²˜ ì„œë¹„ìŠ¤ë¥¼ ìœ„í•œ ë†’ì€ ì¶”ìƒí™” ë ˆë²¨ì˜ ì•„í‚¤í…ì²˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš° ì´ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
> 
> \- ì‚¬ì§„ ë˜ëŠ” ë¹„ë””ì˜¤ ì´¬ì˜ì„ ì•±ì˜ ì‚¬ìš©ì ê²½í—˜ì— í†µí•©í•˜ëŠ” ì»¤ìŠ¤í…€ ì¹´ë©”ë¼ UIë¥¼ êµ¬ì¶•
> 
> \- ì‚¬ìš©ìê°€ ì´ˆì , ë…¸ì¶œ ë° ì•ˆì •í™” ì˜µì…˜ê³¼ ê°™ì€ ì‚¬ì§„ ë° ë¹„ë””ì˜¤ ìº¡ì²˜ë¥¼ ë³´ë‹¤ ì§ì ‘ì ìœ¼ë¡œ ì œì–´
> 
> \- RAW í˜•ì‹ ì‚¬ì§„, ì‹¬ë„ ë§µ ë˜ëŠ” ì‚¬ìš©ì ì •ì˜ ì‹œê°„ ë©”íƒ€ë°ì´í„°ê°€ ìˆëŠ” ë¹„ë””ì˜¤ì™€ ê°™ì´ ì‹œìŠ¤í…œ ì¹´ë©”ë¼ UIì™€ ë‹¤ë¥¸ ê²°ê³¼ë¥¼ ìƒì„±
> 
> \- ìº¡ì²˜ ì¥ì¹˜ì—ì„œ ì§ì ‘ í”½ì…€ ë˜ëŠ” ì˜¤ë””ì˜¤ ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë°ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì•¡ì„¸ìŠ¤

ì´ ë¶€ë¶„ì—ì„œ ìš°ë¦¬ëŠ” ì²« ë²ˆì§¸ í¬ì¸íŠ¸ë¥¼ ë‹¬ì„±í•  ê²ƒì…ë‹ˆë‹¤.

 ![](/assets/img/wp-content/uploads/2023/07/1_wFzqchSnHNa6bc9SQvbk_g.webp)

ê·¸ë ‡ë‹¤ë©´ ì´ "ìº¡ì²˜ ì„œë¸Œì‹œìŠ¤í…œ(capture subsytem)"ì€ ë¬´ì—‡ì´ë©° ì–´ë–»ê²Œ ì‘ë™í• ê¹Œìš”? í•˜ë“œì›¨ì–´ì—ì„œ ì†Œí”„íŠ¸ì›¨ì–´ë¡œ ì´ì–´ì§€ëŠ” íŒŒì´í”„ë¼ì¸ì´ë¼ê³  ìƒê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì…ì¶œë ¥ì´ ìˆëŠ” ì¤‘ì•™ `AVCaptureSession`ì´ ìˆìŠµë‹ˆë‹¤. ë‘˜ ì‚¬ì´ì˜ ë°ì´í„°ë¥¼ ì¤‘ì¬í•©ë‹ˆë‹¤. ì…ë ¥(input)ì€ iOS ì¥ì¹˜ì˜ ë‹¤ì–‘í•œ ì˜¤ë””ì˜¤/ë¹„ë””ì˜¤ í•˜ë“œì›¨ì–´ êµ¬ì„± ìš”ì†Œì˜ ì†Œí”„íŠ¸ì›¨ì–´ í‘œí˜„ì¸ `AVCaptureDevices`ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤. `AVCaptureOutputs`ëŠ” ìº¡ì²˜ ì„¸ì…˜ì— ê³µê¸‰ë˜ëŠ” í•­ëª©ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” ì˜¤ë¸Œì íŠ¸ ë˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ì…ë‹ˆë‹¤.

Â 

#### **ì„¹ì…˜ 1: AVCaptureSession ì„¤ì •**

ê°€ì¥ ë¨¼ì € í•´ì•¼ í•  ì¼ì€ `AVFoundation` í”„ë ˆì„ì›Œí¬ë¥¼ íŒŒì¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ì„¸ì…˜ì„ ë§Œë“¤ê³  í•´ë‹¹ ì„¸ì…˜ì— ëŒ€í•œ ì°¸ì¡°ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì„¸ì…˜ì—ì„œ ëª¨ë“  ì‘ì—…ì„ ìˆ˜í–‰í•˜ë ¤ë©´ êµ¬ì„±(configuration)ì„ ì‹œì‘í•˜ê³  `beginConfiguration()`ê³¼ `commitConfiguration()`ì„ ê°ê° ì‚¬ìš©í•˜ì—¬ ë³€ê²½ ë‚´ìš©ì„ ì»¤ë°‹í•˜ë„ë¡ ì§€ì‹œí•´ì•¼ í•©ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” ì™œ ì´ê²ƒì„ í•˜ë‚˜ìš”? ì¢‹ì€ ë°©ë²•ì´ë‹ˆê¹Œìš”! ì´ë ‡ê²Œ í•˜ë©´ ìº¡ì²˜ ì„¸ì…˜ì— ìˆ˜í–‰í•˜ëŠ” ëª¨ë“  ì‘ì—…ì´ ì›ìì (atomic)ìœ¼ë¡œ ì ìš©ë˜ë¯€ë¡œ ëª¨ë“  ì‘ì—…ì´ í•œ ë²ˆì— ìˆ˜í–‰ë©ë‹ˆë‹¤.

ìš°ë¦¬ê°€ ì´ê±¸ ì™œ ì›í•´ì•¼ ë˜ë‚˜ìš”? ì´ˆê¸° ì„¤ì •ì— í•„ìš”í•œ ê²ƒì€ ì•„ë‹ˆì§€ë§Œ ì¹´ë©”ë¼ë¥¼ ì „í™˜í•  ë•Œ ë³€ê²½ ì‚¬í•­ì„ ëŒ€ê¸°ì—´(queue)ì— ì¶”ê°€í•˜ë©´(í•œ ì…ë ¥ì„ ì œê±°í•˜ê³  ë‹¤ë¥¸ ì…ë ¥ì„ ì¶”ê°€) ìµœì¢… ì‚¬ìš©ìê°€ ë³´ë‹¤ ì›í™œí•˜ê²Œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ëª¨ë“  êµ¬ì„±ì„ ì™„ë£Œí•œ í›„ ì„¸ì…˜ì„ ì‹œì‘í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

```swift
import UIKit
import AVFoundation

class ViewController: UIViewController {
    // MARK: - Vars
    var captureSession: AVCaptureSession!
    
    ...
    
    // MARK: - Life Cycle
    override func viewDidLoad() {
        super.viewDidLoad()
        setupView()
    }
    
    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
        checkPermissions()
        setupAndStartCaptureSession()
    }
    
    // MARK: - Camera Setup
    func setupAndStartCaptureSession() {
        DispatchQueue.global(qos: .userInitiated).async { [unowned self] in
            // ì„¸ì…˜ ì´ˆê¸°í™”
            captureSession = AVCaptureSession()
            // êµ¬ì„±(configuration) ì‹œì‘
            captureSession.beginConfiguration()
            
            // ... do some configuration? ...
            
            // commit configuration: ë‹¨ì¼ atomic ì—…ë°ì´íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ìº¡ì²˜ ì„¸ì…˜ì˜ êµ¬ì„±ì— ëŒ€í•œ í•˜ë‚˜ ì´ìƒì˜ ë³€ê²½ ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤.
            self.captureSession.commitConfiguration()
            // ìº¡ì²˜ ì„¸ì…˜ ì‹¤í–‰
            captureSession.startRunning()
        }
    }
}
```

Â 

ì™œ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ `setupAndStartCaptureSession()` ë³¸ë¬¸ì„ ì‹¤í–‰í• ê¹Œìš”? ì´ëŠ” `startRunning()`ì´ ì°¨ë‹¨ í˜¸ì¶œ(block call)ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì¦‰, ìº¡ì²˜ ì„¸ì…˜ì´ ì‹¤ì œë¡œ ì‹œì‘ë˜ê±°ë‚˜ ì‹¤íŒ¨í•  ë•Œê¹Œì§€ í•´ë‹¹ ë¼ì¸ì—ì„œ ì•± ì‹¤í–‰ì´ ì¤‘ì§€ë©ë‹ˆë‹¤. ì‹¤íŒ¨ ì—¬ë¶€ëŠ” `NSNotification`ì„ êµ¬ë…(subscribe)í•˜ì—¬ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ì‹¤ì œë¡œ ì„¸ì…˜ì„ êµ¬ì„±í•˜ëŠ” ë°©ë²•ê³¼ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¼ê¹Œìš”? ì—¬ëŸ¬ë¶„ì´ ìƒê°í•˜ê³  ìˆëŠ” ê²ƒì²˜ëŸ¼ ì…ë ¥ê³¼ ì¶œë ¥ì„ ì¶”ê°€í•˜ëŠ” ì‘ì—…ì€ ë‹¹ì—°í•˜ì§€ë§Œ ì‚¬ì‹¤ ê·¸ ì´ìƒì˜ ì¼ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`AVCaptureSession`ì— ëŒ€í•œ ì„¤ëª…ì„œë¥¼ ì‚´í´ë³´ë©´ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤. ëª¨ë‘ ì¤‘ìš”í•˜ì§€ë§Œ ì‹¤ë¬´ì— ì‹¤ì œë¡œ í•„ìš”í•œ ê²ƒë§Œ ì–¸ê¸‰í•˜ê² ìŠµë‹ˆë‹¤.

- ì…ë ¥ ë° ì¶œë ¥ ê´€ë¦¬ â€” ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ì´ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤.
- ì‹¤í–‰ ìƒíƒœ ê´€ë¦¬ â€” í”„ë¡œë•ì…˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¤‘ìš”í•˜ë©° ìº¡ì²˜ ì„¸ì…˜ì—ì„œ ì§„í–‰ë˜ëŠ” ì‘ì—…ì„ ì¶”ì í•  ìˆ˜ ìˆê¸°ë¥¼ ì›í•©ë‹ˆë‹¤.
- ì—°ê²° ê´€ë¦¬ â€” ë°ì´í„° íŒŒì´í”„ë¼ì¸ì— ëŒ€í•œ ë³´ë‹¤ ë¯¸ì„¸í•œ ì¡°ì •(fine tuning)ì„ ì œê³µí•©ë‹ˆë‹¤. ì…ë ¥ê³¼ ì¶œë ¥ì„ ìº¡ì²˜ ì„¸ì…˜ì— ì—°ê²°í•  ë•Œ `AVCaptureConnection` ê°œì²´ë¥¼ í†µí•´ ì•”ì‹œì ìœ¼ë¡œ ë˜ëŠ” ëª…ì‹œì ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤. ì´ ë‚´ìš©ì€ ë‚˜ì¤‘ì— ë‹¤ë£° ê²ƒì…ë‹ˆë‹¤.
- ìƒ‰ ê³µê°„(Color Space) ê´€ë¦¬ â€” ì´ê²ƒì€ ë” ë„“ì€ ìƒ‰ ì˜ì—­(ê°€ëŠ¥í•œ ê²½ìš°)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. iPhone 7s ì´ìƒì—ëŠ” P3 ìƒ‰ ì˜ì—­ì´ ìˆëŠ” ë°˜ë©´ êµ¬í˜• ê¸°ê¸°ì—ëŠ” sRGBë§Œ ìˆìœ¼ë¯€ë¡œ ì´ë¥¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Â 

ì´ ì„¹ì…˜ì—ì„œëŠ” ì¶œë ¥ì˜ í’ˆì§ˆ ìˆ˜ì¤€(quality level)ì¸ í”„ë¦¬ì…‹ì— ëŒ€í•´ ë‹¤ë£¹ë‹ˆë‹¤. ìº¡ì²˜ ì„¸ì…˜ì€ ì…ë ¥ê³¼ ì¶œë ¥ ì‚¬ì´ì˜ ì¤‘ì¬ìì´ë¯€ë¡œ ì´ëŸ¬í•œ ê²ƒ ì¤‘ ì¼ë¶€ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `AVCaptureSession.Presets`ëŠ” ê¸°ê¸°ì—ì„œ ë‚˜ì˜¤ëŠ” í’ˆì§ˆì„ ë¯¸ì„¸ ì¡°ì •í•˜ëŠ” ë” ë†’ì€ ì¶”ìƒí™” ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤. ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ ê¸°ê¸° ë ˆë²¨ì—ì„œ í›¨ì”¬ ë” ê¹Šì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì¹´ë©”ë¼ë¥¼ ë§Œë“¤ê³  ìˆê¸° ë•Œë¬¸ì— ì‚¬ì§„ í”„ë¦¬ì…‹ ì„¤ì •ì´ ê°€ì¥ ì í•©í•©ë‹ˆë‹¤. ì´ í”„ë¦¬ì…‹ì€ ìµœê³  í’ˆì§ˆì˜ ì´ë¯¸ì§€ë¥¼ ë°˜í™˜í•˜ëŠ” êµ¬ì„±ì„ ì‚¬ìš©í•˜ë„ë¡ ì—°ê²°ëœ ì¥ì¹˜(ì¹´ë©”ë¼)ì— ì§€ì‹œí•©ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” í’ˆì§ˆì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ê¸° ë•Œë¬¸ì— ë” ë„“ì€ ìƒ‰ ì˜ì—­ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´ ë” ë„“ì€ ìƒ‰ ê³µê°„ì„ í™œì„±í™”í•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

```swift
func setupAndStartCaptureSession() {
    DispatchQueue.global(qos: .userInitiated).async { [unowned self] in
        // ì„¸ì…˜ ì´ˆê¸°í™”
        captureSession = AVCaptureSession()
        // êµ¬ì„±(configuration) ì‹œì‘
        captureSession.beginConfiguration()
        
        // session specific configuration
        // ì„¸ì…˜ í”„ë¦¬ì…‹ì„ ì„¤ì •í•˜ê¸° ì „ì— ì§€ì› ì—¬ë¶€ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
        if captureSession.canSetSessionPreset(.photo) {
            captureSession.sessionPreset = .photo
        }
        
        // ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° ì„¸ì…˜ì´ ìë™ìœ¼ë¡œ ê´‘ì—­ ìƒ‰ìƒì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
        captureSession.automaticallyConfiguresCaptureDeviceForWideColor = true
        
        // commit configuration: ë‹¨ì¼ atomic ì—…ë°ì´íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ìº¡ì²˜ ì„¸ì…˜ì˜ êµ¬ì„±ì— ëŒ€í•œ í•˜ë‚˜ ì´ìƒì˜ ë³€ê²½ ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤.
        self.captureSession.commitConfiguration()
        // ìº¡ì²˜ ì„¸ì…˜ ì‹¤í–‰
        captureSession.startRunning()
    }
}
```

ì´ì œ ì…ë ¥ì„ ì„¤ì •í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤ â˜ºï¸.

Â 

#### **ì„¹ì…˜ 2: ì…ë ¥ ì„¤ì •**

> [`AVCaptureDevice`](https://developer.apple.com/documentation/avfoundation/avcapturedevice) ìº¡ì²˜ ì„¸ì…˜ì— ëŒ€í•œ ì…ë ¥(ì˜ˆ: ì˜¤ë””ì˜¤ ë˜ëŠ” ë¹„ë””ì˜¤)ì„ ì œê³µí•˜ê³  í•˜ë“œì›¨ì–´ë³„ ìº¡ì²˜ ê¸°ëŠ¥ì— ëŒ€í•œ ì»¨íŠ¸ë¡¤ì„ ì œê³µí•˜ëŠ” ì¥ì¹˜ì…ë‹ˆë‹¤.

ì´ ì˜¤ë¸Œì íŠ¸ëŠ” "ìº¡ì²˜ ì¥ì¹˜"ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ìº¡ì²˜ ì¥ì¹˜ëŠ” ì¹´ë©”ë¼ë‚˜ ë§ˆì´í¬ì™€ ê°™ì€ í•˜ë“œì›¨ì–´ì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ í”¼ë“œí•  ìˆ˜ ìˆë„ë¡ ìº¡ì²˜ ì„¸ì…˜ì— ì—°ê²°í•©ë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ ì „ë©´ ì¹´ë©”ë¼ì™€ í›„ë©´ ì¹´ë©”ë¼ ë‘ ê°œì˜ ì¥ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.

Â 

##### **ì˜µì…˜ 1:**

```swift
func default(for mediaType: AVMediaType) -> AVCaptureDevice?
```

ì´ê²ƒì€ AVMediaTypeì„ ì‚¬ìš©í•˜ë©° ë§ì€ íƒ€ì…ì´ ìˆìŠµë‹ˆë‹¤â€¦ ğŸ¥´

- audio
- closedCaption
- depthData
- metadata
- metadataObject
- muxed
- subtitle
- text
- timecode
- video

Â 

ë³´ì‹œë‹¤ì‹œí”¼ ì´ êµ¬ì¡°ì²´(`struct`)ëŠ” `AVCaptureDevices`ë§Œì„ ìœ„í•œ ê²ƒì´ ì•„ë‹ˆë¼ ìë§‰ ë° í…ìŠ¤íŠ¸ì™€ ê°™ì€ í•­ëª©ì„ í¬í•¨í•©ë‹ˆë‹¤. ì°¸ê³ ë¡œ ì €í¬ê°€ ì‹ ê²½ì“°ëŠ” ë¶€ë¶„ì€ ì˜ìƒì¸ë° ì—¬ê¸°ì—ì„œëŠ” ì „ë©´ ì¹´ë©”ë¼ì¸ì§€ í›„ë©´ ì¹´ë©”ë¼ì¸ì§€ ì§€ì •í•  ë°©ë²•ì´ ì—†ê¸° ë•Œë¬¸ì— ì´ ì˜µì…˜ì€ ì§„í–‰í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤.

ìš°ë¦¬ê°€ ë¹„ë””ì˜¤ì— ê´€ì‹¬ì´ ìˆë‹¤ê³  ë§í–ˆì§€ë§Œ ì™œ ë¹„ë””ì˜¤ì¼ê¹Œìš”? ì‚¬ì§„ ì˜µì…˜ì´ ì—†ëŠ” ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œìš”? ì¹´ë©”ë¼(ë° ì¼ë°˜ì ìœ¼ë¡œ ë””ì§€í„¸ ì¹´ë©”ë¼)ëŠ” ì‚¬ì§„ì„ ì°ìœ¼ë ¤ê³  í•  ë•Œ ì¼œì§€ì§€ ì•Šê³  ê·¸ ì „ì— ë¯¸ë¦¬ ì¼œì§‘ë‹ˆë‹¤. ì‚¬ì§„ì„ ì°ì§€ ì•ŠëŠ” ë™ì•ˆ ê·¸ë“¤ì€ ë¹„ë””ì˜¤ ìº¡ì²˜ ì¥ì¹˜ë¡œ ì‘ë™í•˜ì§€ë§Œ ì‚¬ì§„ì„ ì°ëŠ”ë‹¤ëŠ” ê²ƒì€ ì‹¤ì œë¡œ ì´ë¯¸ ì œì‘ ì¤‘ì¸ ë¹„ë””ì˜¤ì—ì„œ í”„ë ˆì„ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

Â 

##### **ì˜µì…˜ 2:**

```swift
func default(_ deviceType: AVCaptureDevice.DeviceType, 
            for mediaType: AVMediaType?, 
                 position: AVCaptureDevice.Position
            ) -> AVCaptureDevice?
```

ì´ ë©”ì„œë“œëŠ” ì¹´ë©”ë¼ ìœ„ì¹˜(ì•, ë’¤ ë˜ëŠ” ë¯¸ì§€ì •) ë° ê¸°ê¸° íƒ€ì…(`deviceType`)ì´ë¼ëŠ” 2ê°œì˜ ìƒˆë¡œìš´ ë§¤ê°œë³€ìˆ˜ë¥¼ ë„ì…í•©ë‹ˆë‹¤.

`AVCaptureDevice.DeviceType` ì•„ë˜ë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì˜µì…˜ì˜ ì–‘ì— ë†€ë„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- **builtInDualCamera**
- **builtInDualWideCamera**
- **buildInTripleCamera**
- **builtInWideAngleCamera**
- **builtInUltraWideCamera**
- **builtInTelephotoCamera**
- **builtInTrueDepthCamera**
- **builtInMicrophone**
- **externalUnkown**

ë§ˆì´í¬ëŠ” í•˜ë‚˜ë¿ì´ë¯€ë¡œ ë°”ë¡œ ì•Œê¸° ì‰½ì§€ë§Œ, ë‚˜ë¨¸ì§€ ì¹´ë©”ë¼ ì¢…ë¥˜ë“¤ì€ í—·ê°ˆë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì¼ë‹¨ êµ¬ê¸€ë§ì€ ì ì‹œ ì ‘ì–´ë‘ì„¸ìš”.

ìš´ ì¢‹ê²Œë„ ëª¨ë“  ì¥ì¹˜ì—ëŠ” ì „ë©´ê³¼ í›„ë©´ ëª¨ë‘ì— `builtInWideAngleCamera`ê°€ ìˆìŠµë‹ˆë‹¤. ì´ ì¹´ë©”ë¼ ìœ í˜•ì„ ê³ ìˆ˜í•˜ëŠ” ë° ì•„ë¬´ëŸ° ë¬¸ì œê°€ ì—†ìœ¼ë©° ë‹¨ìˆœí•¨ì„ ìœ„í•´ ì´ê²ƒì„ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.. ì‹¤ì œ ì‘ìš© í”„ë¡œê·¸ë¨ì—ì„œëŠ” ì‚¬ìš©ì ì¥ì¹˜ì— ìˆì„ ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ë” ë‚˜ì€ ì¹´ë©”ë¼ ì˜µì…˜ì„ í™œìš©í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ìš°ë¦¬ê°€ ì°¾ê³  ìˆëŠ” ê²ƒì´ ë¬´ì—‡ì¸ì§€ ì•Œì•˜ìœ¼ë¯€ë¡œ ê·¸ê²ƒì„ ê°€ì ¸ì˜¤ê³  í›„ë©´ ì¹´ë©”ë¼ë¥¼ ìº¡ì²˜ ì„¸ì…˜ì— ì—°ê²°í•˜ê² ìŠµë‹ˆë‹¤(ì¼ë°˜ì ìœ¼ë¡œ ì¹´ë©”ë¼ ì•±ì€ í›„ë©´ ì¹´ë©”ë¼ì— ì—´ë¦¬ê¸° ë•Œë¬¸ì—).

```
class ViewController: UIViewController {
    // MARK: - Vars
    var captureSession: AVCaptureSession!
    
    var backCamera: AVCaptureDevice!
    var frontCamera: AVCaptureDevice!
    var backInput: AVCaptureInput!
    var frontInput: AVCaptureInput!
    
    ...
    
    // MARK: - Camera Setup
    func setupAndStartCaptureSession() {
        DispatchQueue.global(qos: .userInitiated).async { [unowned self] in
            // ì„¸ì…˜ ì´ˆê¸°í™”
            captureSession = AVCaptureSession()
            // êµ¬ì„±(configuration) ì‹œì‘
            captureSession.beginConfiguration()
            
            // session specific configuration
            // ì„¸ì…˜ í”„ë¦¬ì…‹ì„ ì„¤ì •í•˜ê¸° ì „ì— ì§€ì› ì—¬ë¶€ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
            if captureSession.canSetSessionPreset(.photo) {
                captureSession.sessionPreset = .photo
            }
            
            // ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° ì„¸ì…˜ì´ ìë™ìœ¼ë¡œ ê´‘ì—­ ìƒ‰ìƒì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
            captureSession.automaticallyConfiguresCaptureDeviceForWideColor = true
            
            // Setup inputs
            setupInputs()
            
            // commit configuration: ë‹¨ì¼ atomic ì—…ë°ì´íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ìº¡ì²˜ ì„¸ì…˜ì˜ êµ¬ì„±ì— ëŒ€í•œ í•˜ë‚˜ ì´ìƒì˜ ë³€ê²½ ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤.
            self.captureSession.commitConfiguration()
            // ìº¡ì²˜ ì„¸ì…˜ ì‹¤í–‰
            captureSession.startRunning()
        }
    }
    
    func setupInputs() {
        // í›„ë©´(back) ë° ì „ë©´(front) ì¹´ë©”ë¼
        if let backCamera = AVCaptureDevice.default(.builtInWideAngleCamera, for: .video, position: .back),
           let frontCamera = AVCaptureDevice.default(.builtInWideAngleCamera, for: .video, position: .front) {
            self.backCamera = backCamera
            self.frontCamera = frontCamera
        } else {
            fatalError("No cameras.")
        }
        
        // ì´ì œ ê¸°ê¸°ë¡œë¶€í„° ì…ë ¥ ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
        guard let backInput = try? AVCaptureDeviceInput(device: self.backCamera) else {
            fatalError("could not create input device from back camera")
        }
        self.backInput = backInput
        if !captureSession.canAddInput(self.backInput) {
            fatalError("could not add back camera input to capture session")
        }
        
        guard let frontInput = try? AVCaptureDeviceInput(device: self.frontCamera) else {
            fatalError("could not create input device from front camera")
        }
        self.frontInput = frontInput
        if !captureSession.canAddInput(self.frontInput) {
            fatalError("could not add front camera input to capture session")
        }

        // **í›„ë©´ ì¹´ë©”ë¼ ì…ë ¥ì„ ì„¸ì…˜ì— ì—°ê²°í•©ë‹ˆë‹¤.
        captureSession.addInput(backInput)
    }
    
    ...

}

```

`setupAndStartCaptureSession()` í•¨ìˆ˜ ë‚´ì—ì„œ `setupInputs()`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì´ì œ ì…ë ¥ì´ ìˆìŠµë‹ˆë‹¤ ğŸ˜. ì´ì œ ì•ì—ì„œ ì¥ì¹˜ë¥¼ ìº¡ì²˜ ì„¸ì…˜ì— ì—°ê²°í•œë‹¤ê³  ë§í–ˆì§€ë§Œ ì‚¬ì‹¤ì´ì§€ë§Œ ì¥ì¹˜ê°€ ì—°ê²°ë˜ëŠ” ë°©ì‹ì€ ì¥ì¹˜ë¥¼ ì…ë ¥ ì˜¤ë¸Œì íŠ¸ì¸ `AVCaptureInput`ìœ¼ë¡œ ë°”ê¾¸ëŠ” ê²ƒì…ë‹ˆë‹¤.

> [`AVCaptureInput`](https://developer.apple.com/documentation/avfoundation/avcaptureinput) ìº¡ì²˜ ì„¸ì…˜ì— ì…ë ¥ ë°ì´í„°ë¥¼ ì œê³µí•˜ëŠ” ê°ì²´ì˜ ì¶”ìƒ ìŠˆí¼í´ë˜ìŠ¤

ì—¬ëŸ¬ ë°ì´í„° ìŠ¤íŠ¸ë¦¼ì„ ì „ì†¡í•˜ëŠ” ì¥ì¹˜ì˜ í¬íŠ¸ë¡œ ì´ë™í•˜ë ¤ëŠ” ê²½ìš°ì— ìœ ìš©í•©ë‹ˆë‹¤.

<!-- \[the\_ad id="3020"\] -->

##### **AVCaptureDevices êµ¬ì„±**

ì´ì „ ì„¹ì…˜ì—ì„œ ëª‡ ê°€ì§€ ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ìº¡ì²˜ ì„¸ì…˜ êµ¬ì„±ì— ëŒ€í•´ ë…¼ì˜í–ˆìœ¼ë©° ìº¡ì²˜ ì¥ì¹˜ì— ëŒ€í•´ í›¨ì”¬ ë” ìì„¸íˆ ì•Œì•„ë³¼ ìˆ˜ ìˆë‹¤ê³  ì–¸ê¸‰í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒì€ ì œê³µë˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.

- **Formats (í˜•ì‹)** â€”í•´ìƒë„(resolution), ì¢…íš¡ë¹„(aspect ratio), ì£¼ì‚¬ìœ¨(refresh rate) ë“±
- **Image Exposure (ì´ë¯¸ì§€ ë…¸ì¶œ)**
- **Depth data (ê¹Šì´ ë°ì´í„°)**
- **Zoom (ì¤Œ)**
- **Focus (í¬ì»¤ìŠ¤)**
- **Flash (í”Œë˜ì‹œ)**
- **Torch** â€” íŠ¹íˆ í”Œë˜ì‹œë¼ì´íŠ¸ ëª¨ë“œì—ì„œ
- **Framerate(í”„ë ˆì„ë ˆì´íŠ¸)**
- **Transport** â€” things like playback speed
- **Lens position (ë Œì¦ˆ ìœ„ì¹˜)**
- **White balance (í™”ì´íŠ¸ ë°¸ëŸ°ìŠ¤)**
- **ISO** â€” ì´ë¯¸ì§€ ì„¼ì„œì˜ ê°ê´‘ë„ (sensitivity)
- **HDR**
- **Color spaces (ìƒ‰ ê³µê°„)**
- **Geometric distortion correction**
- **Device calibration**
- **Tone Mapping**

ê·¸ë¦¬ê³  ì´ë“¤ ì¤‘ ëŒ€ë¶€ë¶„ì€ êµ¬ì„± ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì¼ì¢…ì˜ functionê³¼ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤. ë‹¤ë¥¸ "ì¹´ë©”ë¼"ì—ëŠ” ë‹¤ë¥¸ êµ¬ì„± ì˜µì…˜ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  "ì¹´ë©”ë¼"ëŠ” "ë‚´ iPhone 11 Proì˜ í›„ë©´ ì¹´ë©”ë¼"ì™€ ê°™ì€ í•˜ë‚˜ì˜ íšì¼ì ì¸(monolithic) ê°œì²´ê°€ ì•„ë‹™ë‹ˆë‹¤. iOS ê¸°ê¸°, íŠ¹íˆ ìµœì‹  ê¸°ê¸°ì—ëŠ” ê°ê° ë‹¤ë¥¸ ê¸°ëŠ¥ì„ ê°€ì§„ ì¹´ë©”ë¼ ì¥ì¹˜ì— ëŒ€í•œ ì—¬ëŸ¬ ì¹´ë©”ë¼ í‘œí˜„ì´ ìˆìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ì˜µì…˜ì€ í™•ì‹¤íˆ ìœ ìš©í•˜ì§€ë§Œ ì´ íŠœí† ë¦¬ì–¼ì—ì„œëŠ” ë‹¤ë£¨ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”. êµ¬ì„±í•˜ëŠ” ê²ƒì€ ì–´ë µì§€ ì•ŠìŠµë‹ˆë‹¤. Appleì€ ì—¬ê¸° [ì„¤ëª…ì„œ](https://developer.apple.com/documentation/avfoundation/avcapturedevice)ì—ì„œ ì¢‹ì€ ì˜ˆì‹œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

Â 

#### **ì„¹ì…˜ 3: ì¹´ë©”ë¼ í”¼ë“œ í‘œì‹œ**

ì´ì œ ì…ë ¥ì´ ìˆìŠµë‹ˆë‹¤. ì¦‰, ìº¡ì²˜ ì„¸ì…˜ì´ í˜„ì¬ ì¹´ë©”ë¼ì—ì„œ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ìˆ˜ì‹ í•˜ê³  ìˆì§€ë§Œ í™”ë©´ì—ì„œëŠ” ì•„ë¬´ ê²ƒë„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!

ê³ ë§™ê²Œë„ AVFoundation í”„ë ˆì„ì›Œí¬ëŠ” `AVCaptureVideoPreviewLayer`ë¼ëŠ” ë¹„ë””ì˜¤ í”¼ë“œë¥¼ í‘œì‹œí•˜ëŠ” ë§¤ìš° ê°„ë‹¨í•œ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

ì´ê²ƒì€ ë§¤ìš° ê°„ë‹¨í•©ë‹ˆë‹¤. ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ëŠ” ìº¡ì²˜ ì„¸ì…˜ì—ì„œ ìƒì„±í•  ìˆ˜ ìˆëŠ” `CALayer`ì¼ ë¿ì´ë©° Viewì— í•˜ìœ„ ë ˆì´ì–´ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë ˆì´ì–´ê°€ í•˜ëŠ” ì¼ì€ ìº¡ì²˜ ì„¸ì…˜ì„ í†µí•´ ì‹¤í–‰ë˜ëŠ” ë¹„ë””ì˜¤ë¥¼ ì œê³µí•˜ëŠ” ê²ƒ ë¿ì…ë‹ˆë‹¤.

```
class ViewController: UIViewController {
    // MARK: - Vars
    var previewLayer: AVCaptureVideoPreviewLayer!
    
    ...

    // MARK: - Camera Setup
    func setupAndStartCaptureSession() {
        DispatchQueue.global(qos: .userInitiated).async { [unowned self] in
            // ì„¸ì…˜ ì´ˆê¸°í™”
            captureSession = AVCaptureSession()
            // êµ¬ì„±(configuration) ì‹œì‘
            captureSession.beginConfiguration()
            
            // session specific configuration
            // ì„¸ì…˜ í”„ë¦¬ì…‹ì„ ì„¤ì •í•˜ê¸° ì „ì— ì§€ì› ì—¬ë¶€ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
            if captureSession.canSetSessionPreset(.photo) {
                captureSession.sessionPreset = .photo
            }
            
            // ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° ì„¸ì…˜ì´ ìë™ìœ¼ë¡œ ê´‘ì—­ ìƒ‰ìƒì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
            captureSession.automaticallyConfiguresCaptureDeviceForWideColor = true
            
            // Setup inputs
            setupInputs()
            
            // UI ê´€ë ¨ ë¶€ë¶„ì€ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
            DispatchQueue.main.async {
                // ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ ì…‹ì—…
                self.setupPreviewLayer()
            }
            
            // commit configuration: ë‹¨ì¼ atomic ì—…ë°ì´íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ìº¡ì²˜ ì„¸ì…˜ì˜ êµ¬ì„±ì— ëŒ€í•œ í•˜ë‚˜ ì´ìƒì˜ ë³€ê²½ ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤.
            self.captureSession.commitConfiguration()
            // ìº¡ì²˜ ì„¸ì…˜ ì‹¤í–‰
            captureSession.startRunning()
        }
    }
    
    ...
    
    func setupPreviewLayer() {
        previewLayer = AVCaptureVideoPreviewLayer(session: captureSession)
        view.layer.insertSublayer(previewLayer, below: switchCameraButton.layer)
        previewLayer.frame = self.view.frame
    }
    
    ...
    

}
```

ë§ˆì¹¨ë‚´ ì•±ì„ ì‹¤í–‰í•˜ê³  ë¬´ì–¸ê°€ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

 ![](/assets/img/wp-content/uploads/2023/07/1_dr6SNE5dpnpsfPvFnz3sIw.webp)

Â 

ì´ì œ í¬ê¸° ì¡°ì • ë° ì¢…íš¡ë¹„ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤. êµ¬ì„±ì´ ë‹¤ë¥´ë©´ ì¹˜ìˆ˜ê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì‚¬ì§„ ìº¡ì²˜ ì„¸ì…˜ ì‚¬ì „ ì„¤ì •ì„ ì‚¬ìš©í•˜ì—¬ iPhone Xì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ê²½ìš° í›„ë©´ ì¹´ë©”ë¼ì˜ í™œì„± í˜•ì‹ í¬ê¸°ëŠ” 4032x3024ì…ë‹ˆë‹¤. ì´ëŠ” êµ¬ì„± ì˜µì…˜ì— ë”°ë¼ ë³€ê²½ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ iPhone Xì˜ í›„ë©´ ì¹´ë©”ë¼ì— ëŒ€í•´ ìµœëŒ€ í”„ë ˆì„ ì†ë„ ì˜µì…˜ì„ ì‚¬ìš©í•˜ê¸°ë¡œ ì„ íƒí•œ ê²½ìš° 240FPSë¥¼ ì–»ì„ ìˆ˜ ìˆì§€ë§Œ í›¨ì”¬ ëœ ì¸ìƒì ì¸ 1280x720 í•´ìƒë„ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.

ê³§ ë³´ê²Œ ë  ì „ë©´ ì¹´ë©”ë¼ì˜ í¬ê¸°ë„ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì‚¬ì§„ ìº¡ì²˜ ì„¸ì…˜ ì‚¬ì „ ì„¤ì •ì´ ìˆëŠ” iPhone Xì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš° ì „ë©´ í•´ìƒë„ëŠ” 3088x2320ì…ë‹ˆë‹¤. ì´ëŠ” í›„ë©´ ì¹´ë©”ë¼ì™€ ê±°ì˜ ë™ì¼í•œ ì¢…íš¡ë¹„ì´ë¯€ë¡œ ì‚¬ìš©ìê°€ í¬ê¸° ë³€í™”ë¥¼ ì•Œì•„ì°¨ë¦¬ì§€ ëª»í•  ê²ƒì…ë‹ˆë‹¤. êµ¬ì„±ì— ë”°ë¼ ì¢…íš¡ë¹„ê°€ ëª¨ë“  ê³³ì— ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. UIëŠ” ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°ê°€ ì œê³µí•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì¢…íš¡ë¹„ì—ì„œ ì‘ë™í•´ì•¼ í•©ë‹ˆë‹¤.

í”„ë ˆì„ì´ ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ë¥¼ ì±„ìš°ëŠ” ë°©ë²•ì„ ì•Œê³  ì‹¶ë‹¤ë©´ [`videoGravity`](https://developer.apple.com/documentation/avfoundation/avcapturevideopreviewlayer/1386708-videogravity) ì†ì„±ì„ ì‚´í´ë³´ì„¸ìš”.

Â 

#### **ì„¹ì…˜ 4: ì¶œë ¥ ì„¤ì • ë° ì‚¬ì§„ ì°ê¸°**

ì¶œë ¥(output)ì€ ìº¡ì²˜ ì„¸ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë„ë¡ ìº¡ì²˜ ì„¸ì…˜ì— ì—°ê²°í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ì „ ì„¹ì…˜ì—ì„œ ë‚´ì¥ëœ ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ë¥¼ íƒìƒ‰í–ˆìŠµë‹ˆë‹¤. ê·¸ ì˜¤ë¸Œì íŠ¸ëŠ” ì •ì˜ìƒ ì¶œë ¥ì´ê¸°ë„ í•©ë‹ˆë‹¤.

ì—¬ê¸°ì—ëŠ” ë‘ ê°€ì§€ ì˜µì…˜ì´ ìˆìœ¼ë©° ë‘˜ ë‹¤ [AVCaptureOutputs](https://developer.apple.com/documentation/avfoundation/avcaptureoutput)ì…ë‹ˆë‹¤.

> ìº¡ì²˜ ì„¸ì…˜ì—ì„œ ê¸°ë¡ëœ ë¯¸ë””ì–´ë¥¼ ì¶œë ¥í•˜ëŠ” ì˜¤ë¸Œì íŠ¸ì…ë‹ˆë‹¤.

ì¦‰, ìº¡ì²˜ ì„¸ì…˜ì´ ì…ë ¥ ì¥ì¹˜ì—ì„œ ì¤‘ì¬í•˜ëŠ” ë°ì´í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

Â 

##### **ì˜µì…˜ 1:**

ì´ê²ƒì€ [`AVCapturePhotoOutput`](https://developer.apple.com/documentation/avfoundation/avcapturephotooutput) ì´ë¼ëŠ” ë§¤ìš° ê°„ë‹¨í•œ ì˜µì…˜ì…ë‹ˆë‹¤. í•´ì•¼ í•  ì¼ì€ ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  ì„¸ì…˜ì— ì—°ê²°í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìº¡ì²˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê·¸ê²ƒì— ëŒ€í•´ `capturePhoto(with:delegate:)`ë¥¼ í˜¸ì¶œí•˜ë©´ ì¡°ì‘/ì €ì¥í•  ìˆ˜ ìˆëŠ” ì‚¬ì§„ ì˜¤ë¸Œì íŠ¸ë¥¼ ë‹¤ì‹œ ë°›ê²Œ ë©ë‹ˆë‹¤. ì´ê²ƒì€ ê°•ë ¥í•œ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. Live Photosë¥¼ ì°ì„ ìˆ˜ ìˆê³ , ì‚¬ì§„ ìì²´ë¥¼ ì°ê³  ì›í•˜ëŠ” í‘œí˜„ì„ ìœ„í•œ ìˆ˜ë§ì€ ì˜µì…˜ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì‹ ë§Œì˜ ì•±ì— ë§ëŠ” ì»¤ìŠ¤í…€ UIì˜ ì¼ë°˜ ì¹´ë©”ë¼ë¥¼ ì›í•œë‹¤ë©´ ì´ í´ë˜ìŠ¤ëŠ” ì™„ë²½í•©ë‹ˆë‹¤.

Â 

##### **ì˜µì…˜ 2:**

ì´ ì˜µì…˜ì€ raw ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ê²ƒì€ êµ¬í˜„í•˜ê¸° ì‰¬ìš°ë©´ì„œë„ ì´ ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ ì¹´ë©”ë¼ë¥¼ ëª¨ë“  ë°©í–¥ìœ¼ë¡œ ê°€ì ¸ê°ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰í•  ê²ƒì…ë‹ˆë‹¤.

> [`AVCaptureVideoDataOutput`](https://developer.apple.com/documentation/avfoundation/avcapturevideodataoutput) ë¹„ë””ì˜¤ë¥¼ ë…¹í™”í•˜ê³  ì²˜ë¦¬ë¥¼ ìœ„í•´ ë¹„ë””ì˜¤ í”„ë ˆì„ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ìº¡ì²˜ ì¶œë ¥.

ì˜¤ë¸Œì íŠ¸ì˜ ì´ë¦„ì— ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ë©´ ì´ì „ ì˜µì…˜ê³¼ ê°™ì´ ì‚¬ì§„ì´ ì•„ë‹Œ ë¹„ë””ì˜¤ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì¹´ë©”ë¼ì—ì„œ ëª¨ë“  ë‹¨ì¼ í”„ë ˆì„ì„ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. í•´ë‹¹ í”„ë ˆì„ìœ¼ë¡œ ìˆ˜í–‰í•  ì‘ì—…ì„ ê²°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰, ì‚¬ìš©ìê°€ ì¹´ë©”ë¼ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œ ë“¤ì–´ì˜¤ëŠ” ë‹¤ìŒ í”„ë ˆì„ì„ ë½‘ê¸°(pluck)ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. ë˜í•œ ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ê³  ìˆëŠ” ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ë¥¼ ë²„ë¦´ ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸ì´ê¸°ë„ í•©ë‹ˆë‹¤.

í•­ìƒ ê·¸ë ‡ë“¯ì´ ì´ ì¶œë ¥ ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•œ ë§ì€ êµ¬ì„± ì˜µì…˜ì´ ìˆì§€ë§Œ ì´ íŠœí† ë¦¬ì–¼ê³¼ëŠ” ê´€ë ¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìš°ë¦¬ì˜ ê´€ì‹¬ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```swift
func setSampleBufferDelegate(_ sampleBufferDelegate: AVCaptureVideoDataOutputSampleBufferDelegate?, 
                    queue sampleBufferCallbackQueue: DispatchQueue?)
```

ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ëŠ” í”„ë ˆì„ê³¼ í•¨ê»˜ ì½œë°±í•  ëŒ€ë¦¬ì(delegate)ì´ê³  ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ëŠ” ì½œë°±ì´ í˜¸ì¶œë˜ëŠ” queueì…ë‹ˆë‹¤. ì¹´ë©”ë¼ì˜ í”„ë ˆì„ ì†ë„ë¡œ í˜¸ì¶œë˜ë©°(íê°€ ì‚¬ìš© ì¤‘ì´ ì•„ë‹Œ ê²½ìš°) í•´ë‹¹ ì½œë°± ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ë¯€ë¡œ ê¸°ë³¸(UI) ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ê²ƒì´ ì‚¬ìš©ì„±ì— ìˆì–´ ì¤‘ìš”í•©ë‹ˆë‹¤.

ìƒˆ í”„ë ˆì„ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ë•Œ ì‹¤í–‰ ì¤‘ì¸ ëŒ€ê¸°ì—´ì´ ì‚¬ìš© ì¤‘ì¸ ê²½ìš° `alwaysDiscardsLateVideoFrames` ì†ì„±ì— ë”°ë¼ "ëŠ¦ì€" í”„ë ˆì„ì„ ì‚­ì œí•©ë‹ˆë‹¤.

```
class ViewController: UIViewController {
    // MARK: - Vars
    ...
    
    var videoOutput: AVCaptureVideoDataOutput!
    
    ...
    
    // MARK: - Camera Setup
    func setupAndStartCaptureSession() {
        DispatchQueue.global(qos: .userInitiated).async { [unowned self] in
            // ì„¸ì…˜ ì´ˆê¸°í™”
            captureSession = AVCaptureSession()
            // êµ¬ì„±(configuration) ì‹œì‘
            captureSession.beginConfiguration()
            
            // session specific configuration
            // ì„¸ì…˜ í”„ë¦¬ì…‹ì„ ì„¤ì •í•˜ê¸° ì „ì— ì§€ì› ì—¬ë¶€ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
            if captureSession.canSetSessionPreset(.photo) {
                captureSession.sessionPreset = .photo
            }
            
            // ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° ì„¸ì…˜ì´ ìë™ìœ¼ë¡œ ê´‘ì—­ ìƒ‰ìƒì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
            captureSession.automaticallyConfiguresCaptureDeviceForWideColor = true
            
            // Setup inputs
            setupInputs()
            
            // UI ê´€ë ¨ ë¶€ë¶„ì€ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
            DispatchQueue.main.async {
                // ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ ì…‹ì—…
                self.setupPreviewLayer()
            }
            
            // Setup output
            setupOutput()
            
            // commit configuration: ë‹¨ì¼ atomic ì—…ë°ì´íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ìº¡ì²˜ ì„¸ì…˜ì˜ êµ¬ì„±ì— ëŒ€í•œ í•˜ë‚˜ ì´ìƒì˜ ë³€ê²½ ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤.
            self.captureSession.commitConfiguration()
            // ìº¡ì²˜ ì„¸ì…˜ ì‹¤í–‰
            captureSession.startRunning()
        }
    }
    
    ...
    
    func setupOutput() {
        videoOutput = AVCaptureVideoDataOutput()
        let videoQueue = DispatchQueue(label: "videoQueue", qos: .userInteractive)
        videoOutput.setSampleBufferDelegate(self, queue: videoQueue)
        
        if captureSession.canAddOutput(videoOutput) {
            captureSession.addOutput(videoOutput)
        } else {
            fatalError("could not add video output")
        }
    }
    
    ...
}

extension ViewController: AVCaptureVideoDataOutputSampleBufferDelegate {
    func captureOutput(_ output: AVCaptureOutput, didOutput sampleBuffer: CMSampleBuffer, from connection: AVCaptureConnection) {
        
    }
}

```

ë³´ì‹œë‹¤ì‹œí”¼ ì¶œë ¥ ì„¤ì •ì€ ë‹¤ì†Œ ì‰¬ì› ìŠµë‹ˆë‹¤. ì´ì œ ëŒ€ë¦¬ì í•¨ìˆ˜ `captureOutput`ê³¼ í•´ë‹¹ 3ê°œì˜ íŒŒë¼ë¯¸í„°ì— ì´ˆì ì„ ë§ì¶¥ë‹ˆë‹¤.

ì¶œë ¥ì€ ì´ê²ƒì´ ë‚˜ì˜¨ ì¶œë ¥ ì¥ì¹˜ë¥¼ ì§€ì •í•©ë‹ˆë‹¤(ë™ì¼í•œ ëŒ€ë¦¬ìë¡œ ì—¬ëŸ¬ `AVCaptureOutput` ì˜¤ë¸Œì íŠ¸ë¥¼ ì¤‘ì¬í•˜ëŠ” ê²½ìš°). ìƒ˜í”Œ ë²„í¼ì—ëŠ” ë¹„ë””ì˜¤ í”„ë ˆì„ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ì—°ê²°(connection)ì€ ë°ì´í„°ê°€ ì „ë‹¬ëœ ì—°ê²° ì˜¤ë¸Œì íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì•„ì§ ì—°ê²°ì„ ê±´ë“œë¦¬ì§€ ì•Šì•˜ê³  í•˜ë‚˜ì˜ ì¶œë ¥ ì˜¤ë¸Œì íŠ¸ë§Œ ìˆìœ¼ë¯€ë¡œ ìš°ë¦¬ê°€ ì‹ ê²½ ì“°ëŠ” ìœ ì¼í•œ ê²ƒì€ ìƒ˜í”Œ ë²„í¼ì…ë‹ˆë‹¤.

Â 

> [`CMSampleBuffer`](https://developer.apple.com/documentation/coremedia/cmsamplebuffer-u71) 0ê°œ ë˜ëŠ” 1ê°œ ì´ìƒì˜ ë¯¸ë””ì–´ íŒŒì´í”„ë¼ì¸ì„ í†µí•´ ë¯¸ë””ì–´ ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì´ë™í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” íŠ¹ì • ë¯¸ë””ì–´ ìœ í˜•(ì˜¤ë””ì˜¤, ë¹„ë””ì˜¤, muxed ë“±)ì˜ ì••ì¶•(ë˜ëŠ” ì••ì¶•ë˜ì§€ ì•Šì€) ìƒ˜í”Œì„ í¬í•¨í•˜ëŠ” ì˜¤ë¸Œì íŠ¸

ì´ ì˜¤ë¸Œì íŠ¸ì˜ ì „ì²´ ë²”ìœ„ëŠ” ë‹¤ì†Œ ë³µì¡í•´ì§‘ë‹ˆë‹¤. ìš°ë¦¬ê°€ ì‹ ê²½ì“°ëŠ” ê²ƒì€ ì´ê²ƒì„ ì´ë¯¸ì§€ë¡œ í‘œí˜„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì½”ì½”ì•„ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì–´ë–»ê²Œ í‘œí˜„í• ê¹Œìš”? ì´ë¯¸ì§€ì˜ ì„œë¡œ ë‹¤ë¥¸ ìˆ˜ì¤€ì„ ë‚˜íƒ€ë‚´ëŠ” ì„œë¡œ ë‹¤ë¥¸ í”„ë ˆì„ì›Œí¬ì˜ ê° ë¶€ë¶„ì¸ 3ê°€ì§€ ì£¼ìš” ìœ í˜•ì´ ìˆìŠµë‹ˆë‹¤.

- `UIImage`(UIKit) â€” ìµœê³  ì¶”ìƒí™” ë ˆë²¨ì˜ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ, ë‹¤ì–‘í•œ ì´ë¯¸ì§€ í‘œí˜„ì—ì„œ UIImageë¥¼ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë©° ì´ëŠ” ìš°ë¦¬ ëª¨ë‘ì—ê²Œ ì¹œìˆ™í•œ ê²ƒì…ë‹ˆë‹¤.
- `CGImage`(Core Graphics) â€” ì´ë¯¸ì§€ì˜ ë¹„íŠ¸ë§µ í‘œí˜„
- `CIImage`(Core Image) â€” Core Image í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ ë ˆì‹œí”¼ì…ë‹ˆë‹¤.

Â 

`CMSampleBuffer`ë¡œ ëŒì•„ì˜µë‹ˆë‹¤. ë³¸ì§ˆì ìœ¼ë¡œ ë‹¤ì–‘í•œ ë°ì´í„° ìœ í˜•ì˜ ì „ì²´ ë°°ì—´(array)ì„ í¬í•¨í•  ìˆ˜ ìˆìœ¼ë©°, ìš°ë¦¬ê°€ ì›í•˜ëŠ” ê²ƒì€ ì´ë¯¸ì§€ ë²„í¼ì…ë‹ˆë‹¤. ë‹¤ì–‘í•œ ê²ƒì„ í‘œí˜„í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— Core Media í”„ë ˆì„ì›Œí¬ëŠ” ë‹¤ì–‘í•œ í‘œí˜„(representation)ì„ ì‹œë„í•˜ê³  ê²€ìƒ‰í•  ìˆ˜ ìˆëŠ” ë§ì€ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì‚¬ìš© ê°€ëŠ¥í•œ ê²ƒì€ `CMSampleBufferGetImageBuffer()`ì…ë‹ˆë‹¤. ì´ê²ƒì€ ë‹¤ì‹œ í•œ ë²ˆ ë˜ ë‹¤ë¥¸ íŠ¹ì´í•œ ìœ í˜•ì¸ `CVImageBuffer` ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ì œ ì´ ì´ë¯¸ì§€ ë²„í¼ì—ì„œ `CIImage`ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. `CIImage`ëŠ” ì´ë¯¸ì§€ì˜ ì¬ë£Œ(recipe)ì¼ ë¿ì´ë¯€ë¡œ ì—¬ê¸°ì—ì„œ `UIImage`ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
class ViewController: UIViewController {
    // MARK: - Vars
    ...

    var isTakePicture = false
    
    ...
    
    // MARK: - Actions
    @objc func captureImage(_ sender: UIButton?){
        isTakePicture = true
    }
    
    @objc func switchCamera(_ sender: UIButton?){
        
    }
    
}

extension ViewController: AVCaptureVideoDataOutputSampleBufferDelegate {
    func captureOutput(_ output: AVCaptureOutput, didOutput sampleBuffer: CMSampleBuffer, from connection: AVCaptureConnection) {
        if !isTakePicture {
            return // ì´ë¯¸ì§€ ë²„í¼ë¡œ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.
        }
        
        // ìƒ˜í”Œ ë²„í¼ì—ì„œ CVImageBufferë¥¼ ê°€ì ¸ì˜¤ê¸°
        guard let cvBuffer = CMSampleBufferGetImageBuffer(sampleBuffer) else {
            return
        }
        
        // CVImageBufferì—ì„œ CIImageë¥¼ ê°€ì ¸ì˜¤ê¸°
        let ciImage = CIImage(cvImageBuffer: cvBuffer)
        
        // CIIImageë¥¼ UIImageë¡œ ë³€í™˜
        let uiImage = UIImage(ciImage: ciImage)
        
        // ì´ë¯¸ì§€ í‘œì‹œ (UI ì˜ì—­)
        DispatchQueue.main.async {
            self.capturedImageView.image = uiImage
            self.isTakePicture = false
        }
    }
}

```

ë³´ì‹œë‹¤ì‹œí”¼ ë°˜í™˜ëœ ìƒ˜í”Œ ë²„í¼ë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ê¸° ìœ„í•´ `Bool` í”Œë˜ê·¸ `isTakePicture`ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ì‹¤í–‰í•˜ë©´ ì²« ë²ˆì§¸ ì‚¬ì§„ì´ ì˜¤ë¥¸ìª½ í•˜ë‹¨ ì˜ì—­ì— ë‚˜íƒ€ë‚˜ê²Œ ë©ë‹ˆë‹¤ ğŸ‰

 ![](/assets/img/wp-content/uploads/2023/07/1_aS7RxDiKgNUl8ZZYhfJhkQ.webp)

ë¶ˆí–‰íˆë„ ë°©í–¥ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ëŠ” ìë™ìœ¼ë¡œ ì˜¬ë°”ë¥¸ ë°©í–¥ì„ í‘œì‹œí•˜ì§€ë§Œ `AVCaptureVideoDataOutput` ì˜¤ë¸Œì íŠ¸ë¥¼ í†µí•´ ë“¤ì–´ì˜¤ëŠ” ë°ì´í„°ëŠ” ê·¸ë ‡ì§€ ì•ŠìŠµë‹ˆë‹¤. ì—°ê²° ìì²´(ì¦‰, ì¶œë ¥ ì˜¤ë¸Œì íŠ¸ì™€ ì„¸ì…˜ ê°„ì˜ ì—°ê²°) ë˜ëŠ” `CIImage`ì—ì„œ `UIImage`ë¥¼ ìƒì„±í•  ë•Œ ë‘ ê³³ì—ì„œ ì´ ë¬¸ì œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—°ê²° ìì²´ì—ì„œ ì´ë¥¼ ë³€ê²½í•  ê²ƒì…ë‹ˆë‹¤.

> [`AVCaptureConnection`](https://developer.apple.com/documentation/avfoundation/avcaptureconnection) ìº¡ì²˜ ì„¸ì…˜ì—ì„œ ìº¡ì²˜ ì…ë ¥ê³¼ ìº¡ì²˜ ì¶œë ¥ ì˜¤ë¸Œì íŠ¸ì˜ íŠ¹ì • ìŒ ê°„ì˜ ì—°ê²°ì…ë‹ˆë‹¤.

ì•ì—ì„œ ì…ë ¥ê³¼ ì¶œë ¥ì„ ì—°ê²°í•  ë•Œ ìº¡ì²˜ ì„¸ì…˜ì„ í†µí•´ ì—°ê²°ì´ í˜•ì„±ëœë‹¤ê³  ì–¸ê¸‰í–ˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì—°ê²°ì€ ì˜¤ë¸Œì íŠ¸ ìì²´ì´ë©° ìº¡ì²˜ ì„¸ì…˜ì—ì„œ `addInput()` ë° `addOutput()`ì„ í†µí•´ ì•”ì‹œì ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì—°ê²° ì˜¤ë¸Œì íŠ¸ëŠ” ë°ì´í„° íŒŒì´í”„ë¼ì¸(ì…ë ¥, ìº¡ì²˜ ì„¸ì…˜ ë° ì¶œë ¥) ì „ì²´ì—ì„œ ì–´ë””ì—ì„œë‚˜ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¹„ë””ì˜¤ êµ¬ì„± ê´€ë¦¬ì—ì„œ ì¶œë ¥ ì—°ê²°ì— `videoOrientation`ì„ ì„¤ì •í•˜ëŠ” ì˜µì…˜ì´ ìˆìŠµë‹ˆë‹¤.

```swift
func setupOutput() {
    ...
    
    // ë°©í–¥ì„ í¬íŠ¸ë ˆì´íŠ¸(ì„¸ë¡œ)ë¡œ ì„¤ì •
    videoOutput.connections.first?.videoOrientation = .portrait
}
```

Â 

 ![](/assets/img/wp-content/uploads/2023/07/1_2RKkmdRpmIi68dJGcmnzxA.webp)

ì´ì œ ì‚¬ì§„ì„ ì°ì„ ë•Œ ì˜¬ë°”ë¥¸ ë¹„ë””ì˜¤ ë°©í–¥ì„ ê°–ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

Â 

#### **ì„¹ì…˜ 5: ì¹´ë©”ë¼ ì „í™˜**

ì¢‹ìŠµë‹ˆë‹¤ğŸŸ. ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•˜ê³  ì´¬ì˜í•  ìˆ˜ ìˆëŠ” ì „ì²´ ìº¡ì²˜ íŒŒì´í”„ë¼ì¸ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì „/í›„ë©´ ì¹´ë©”ë¼ë¥¼ ì–´ë–»ê²Œ ë³€ê²½í•´ì•¼ í• ê¹Œìš”?

ìƒê°í•´ ë³´ë©´ ìº¡ì²˜ ì„¸ì…˜ì€ ì…ë ¥ì„ ì¶œë ¥ìœ¼ë¡œ ì¤‘ì¬í•©ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ë°©ê¸ˆ ì¶œë ¥(ì‚¬ì§„ ì´¬ì˜ì„ ìœ„í•œ)ì„ ë‹¤ë£¨ì—ˆê³  ê·¸ ì „ì— ì…ë ¥ ì¥ì¹˜ë¥¼ ê°€ì ¸ì™€ ì…ë ¥ ì˜¤ë¸Œì íŠ¸ë¥¼ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤. í›„ë©´ ì¹´ë©”ë¼ì™€ ì „ë©´ ì¹´ë©”ë¼ ëª¨ë‘ì— ëŒ€í•´ 2ê°œì˜ ì°¸ì¡°ë¥¼ ì €ì¥í–ˆê¸° ë•Œë¬¸ì—(`backInput`, `frontInput`) ì„¸ì…˜ ì˜¤ë¸Œì íŠ¸ë¥¼ ì¬êµ¬ì„±í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

```
class ViewController: UIViewController {
    // MARK: - Vars
    ...
    var isBackCameraOn = true
    
    ...
    
    func switchCameraInput() {
        // ìŠ¤ìœ„ì¹˜ë˜ëŠ” ë™ì•ˆ ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ìŠ¤íŒ¸ì²˜ëŸ¼ ì—°íƒ€í•˜ì§€ ëª»í•˜ë„ë¡ í•©ë‹ˆë‹¤.
        // ì‚¬ìš©ìì—ê²ŒëŠ” ì¬ë¯¸ê°€ ìˆì§€ë§Œ ì„±ëŠ¥ì—ëŠ” ì¬ë¯¸ê°€ ì—†ìŠµë‹ˆë‹¤.
        switchCameraButton.isUserInteractionEnabled = false
        
        // input ì¬ì„¤ì •
        captureSession.beginConfiguration()
        
        if isBackCameraOn {
            captureSession.removeInput(backInput)
            captureSession.addInput(frontInput)
            isBackCameraOn = false
        } else {
            captureSession.removeInput(frontInput)
            captureSession.addInput(backInput)
            isBackCameraOn = true
        }
        
        // ë‹¤ì‹œ ë°©í–¥ì„ í¬íŠ¸ë ˆì´íŠ¸(ì„¸ë¡œ)ë¡œ ì„¤ì •
        videoOutput.connections.first?.videoOrientation = .portrait
        
        // commit config
        captureSession.commitConfiguration()
        
        // ë‹¤ì‹œ ì¹´ë©”ë¼ ìŠ¤ìœ„ì¹˜ ë²„íŠ¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.
        switchCameraButton.isUserInteractionEnabled = true
    }
    
    // MARK: - Actions
    @objc func captureImage(_ sender: UIButton?){
        isTakePicture = true
    }
    
    @objc func switchCamera(_ sender: UIButton?){
        switchCameraInput()
    }
}

```

ì—¬ê¸°ì„œ ì£¼ì˜í•  ì ì€ ì…ë ¥ì„ ë³€ê²½í–ˆê¸° ë•Œë¬¸ì— ì—°ê²° ì˜¤ë¸Œì íŠ¸ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ë¹„ë””ì˜¤ì˜ ì¶œë ¥ ì—°ê²°ì˜ ë¹„ë””ì˜¤ ë°©í–¥ì„ ë‹¤ì‹œ ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ ì¬ì„¤ì •í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

Â 

 ![](/assets/img/wp-content/uploads/2023/07/1_41KPyiV8FVeBAtdVlcfmKQ.webp)

ì‹¤í–‰í•˜ê³  ì‚¬ì§„ì„ ì°ìœ¼ë©´ ì¶œë ¥ ì˜¤ë¸Œì íŠ¸ê°€ ë¯¸ëŸ¬ë§ë˜ì§€ ì•Šì€ ë¹„ë””ì˜¤ë¥¼ ë¦¬í„´í•œ ë°˜ë©´ ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ëŠ” ë¯¸ëŸ¬ë§ëœ ì „ë©´ ì¹´ë©”ë¼ì˜ ë¹„ë””ì˜¤ë¥¼ í‘œì‹œí•œë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¤ë¦¬ì—”í…Œì´ì…˜ê³¼ ê°™ì€ ê²½ìš°ì…ë‹ˆë‹¤. ë¯¸ë¦¬ ë³´ê¸° ë ˆì´ì–´ëŠ” "_ìƒìœ„ ì¶”ìƒí™” ë ˆë²¨ì˜ ì˜¤ë¸Œì íŠ¸_"ì´ê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ë§Œ "_í•˜ìœ„ ì¶”ìƒí™” ë ˆë²¨ì˜ ì˜¤ë¸Œì íŠ¸_"ì¸ ì¶œë ¥ ì˜¤ë¸Œì íŠ¸ì—ì„œëŠ” ì²˜ë¦¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ í˜„ì¬ í‘œì‹œë˜ëŠ” ì¹´ë©”ë¼ì— ë”°ë¼ ì—°ê²°ì— `isVideoMirrored` ì†ì„±ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì „ì— ë¹„ë””ì˜¤ ë°©í–¥ì„ ìˆ˜ì •í•œ ê²ƒì²˜ëŸ¼ ì •ë§ ë¹ ë¥´ê²Œ ìˆ˜ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```swift
func switchCameraInput() {
    ...
    
    // ë‹¤ì‹œ ë°©í–¥ì„ í¬íŠ¸ë ˆì´íŠ¸(ì„¸ë¡œ)ë¡œ ì„¤ì •
    videoOutput.connections.first?.videoOrientation = .portrait
    
    // ì „ë©´ ì¹´ë©”ë¼ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ë¯¸ëŸ¬ë§
    videoOutput.connections.first?.isVideoMirrored = !isBackCameraOn
    
    ...
}
```

ì´ì œ ì‘ì—…ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤ğŸ‰. ìš°ë¦¬ê°€ ì›í•˜ëŠ” UI ìœ í˜•ì— ë§ê²Œ ë§ì¶¤í˜• ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ì§„ì„ ì°ì„ ìˆ˜ ìˆëŠ” í…œí”Œë¦¿ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

 ![](/assets/img/wp-content/uploads/2023/07/1_8fysiGWqpzuFRfjir6NRWw.webp)

Â 

### **ë‹¤ìŒ ë‹¨ê³„**

1. ë” ë§ì€ ì¹´ë©”ë¼ ê¸°ëŠ¥ì„ ì‚´í´ë³´ì„¸ìš”. "ìº¡ì²˜ ì¥ì¹˜ êµ¬ì„±" ì„¹ì…˜ì€ ë‹¹ì‹ ì„ ì••ë„í•˜ê¸° ìœ„í•´ ê±°ê¸°ì— ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì¹´ë©”ë¼ì˜ ê¸°ëŠ¥ì„ í™•ì¥í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. ë¹„ë””ì˜¤! ì‚¬ìš©ìê°€ ì‚¬ì§„ì„ ì°ê³  ì‹¶ì„ ë•Œë§Œ ì¶œë ¥ ê°œì²´ì—ì„œ ê°€ì ¸ì˜¨ í”„ë ˆì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ì‹œê°„ì—ëŠ” í•´ë‹¹ í”„ë ˆì„ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤! ë¹„ë””ì˜¤ ìº¡ì²˜ëŠ” ì‚¬ì†Œí•˜ì§€ëŠ” ì•Šì§€ë§Œ ê·¸ë¦¬ ì–´ë µì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ê²ƒì´ ì˜ë¯¸í•˜ëŠ” ë°”ëŠ” ë¹„ë””ì˜¤ í”„ë ˆì„ì„ íŒŒì¼ë¡œ ë¬¶ëŠ”ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. iOSì—ì„œ ì˜¤ë””ì˜¤ ì¥ì¹˜ë¥¼ ì‚¬ìš©í•˜ì—¬ íƒìƒ‰í•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ê¸°íšŒì´ê¸°ë„ í•©ë‹ˆë‹¤.
3. ì¹´ë©”ë¼ì— í•„í„°ë¥¼ êµ¬í˜„í•´ë³´ì„¸ìš”!

Â 

### **ê²°ë¡ **

- ì´ íŠœí† ë¦¬ì–¼ì„ ì¦ê²¼ê³  ì¹´ë©”ë¼ë¥¼ í•œ ë‹¨ê³„ ë” ë°œì „ì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ í•„í„° ì ìš©ì— ëŒ€í•œ ì œ [íŠœí† ë¦¬ì–¼](https://betterprogramming.pub/using-cifilters-metal-to-make-a-custom-camera-in-ios-c76134993316)ì„ í™•ì¸í•˜ì„¸ìš”!
- iOSì—ì„œ ê·¸ë˜í”½ì— ëŒ€í•´ ë°°ìš°ëŠ” ê²ƒì— ê´€ì‹¬ì´ ìˆë‚˜ìš”? Metal Shaders ì‚¬ìš©ì— ëŒ€í•œ [íŠœí† ë¦¬ì–¼](https://medium.com/better-programming/making-your-first-circle-using-metal-shaders-1e5049ec8505)ì„ í™•ì¸í•˜ì„¸ìš”.
- ì´ë¯¸ Metalì— ìµìˆ™í•˜ì§€ë§Œ ì´ë¥¼ í™œìš©í•˜ì—¬ ë©‹ì§„ ì¼ì„ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì•Œê³  ì‹¶ë‚˜ìš”? ì˜¤ë””ì˜¤ ì‹œê°í™”ì— ëŒ€í•œ ì œ [íŠœí† ë¦¬ì–¼](https://medium.com/better-programming/audio-visualization-in-swift-using-metal-accelerate-part-1-390965c095d7)ì„ í™•ì¸í•˜ì„¸ìš”.

Â 

### **ì „ì²´ ì½”ë“œ**

ViewController.swiftì˜ ì „ì²´ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```
//
//  ViewController.swift
//  CustomCamera
//
//  Created by Alex Barbulescu on 2020-05-21.
//  Copyright Â© 2020 ca.alexs. All rights reserved.
//

import UIKit
import AVFoundation

class ViewController: UIViewController {
    // MARK: - Vars
    var captureSession: AVCaptureSession!
    
    var backCamera: AVCaptureDevice!
    var frontCamera: AVCaptureDevice!
    var backInput: AVCaptureInput!
    var frontInput: AVCaptureInput!
    
    var previewLayer: AVCaptureVideoPreviewLayer!
    
    var videoOutput: AVCaptureVideoDataOutput!
    
    var isTakePicture = false
    var isBackCameraOn = true
    
    // MARK: - View Components
    let switchCameraButton : UIButton = {
        let button = UIButton()
        let image = UIImage(named: "switchcamera")?.withRenderingMode(.alwaysTemplate)
        button.setImage(image, for: .normal)
        button.tintColor = .white
        button.translatesAutoresizingMaskIntoConstraints = false
        return button
    }()
    
    let captureImageButton : UIButton = {
        let button = UIButton()
        button.backgroundColor = .white
        button.tintColor = .white
        button.layer.cornerRadius = 25
        button.translatesAutoresizingMaskIntoConstraints = false
        return button
    }()
    
    let capturedImageView = CapturedImageView()
    
    // MARK: - Life Cycle
    override func viewDidLoad() {
        super.viewDidLoad()
        setupView()
    }
    
    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
        checkPermissions()
        setupAndStartCaptureSession()
    }
    
    // MARK: - Camera Setup
    func setupAndStartCaptureSession() {
        DispatchQueue.global(qos: .userInitiated).async { [unowned self] in
            // ì„¸ì…˜ ì´ˆê¸°í™”
            captureSession = AVCaptureSession()
            // êµ¬ì„±(configuration) ì‹œì‘
            captureSession.beginConfiguration()
            
            // session specific configuration
            // ì„¸ì…˜ í”„ë¦¬ì…‹ì„ ì„¤ì •í•˜ê¸° ì „ì— ì§€ì› ì—¬ë¶€ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
            if captureSession.canSetSessionPreset(.photo) {
                captureSession.sessionPreset = .photo
            }
            
            // ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° ì„¸ì…˜ì´ ìë™ìœ¼ë¡œ ê´‘ì—­ ìƒ‰ìƒì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
            captureSession.automaticallyConfiguresCaptureDeviceForWideColor = true
            
            // Setup inputs
            setupInputs()
            
            // UI ê´€ë ¨ ë¶€ë¶„ì€ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
            DispatchQueue.main.async {
                // ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ ì…‹ì—…
                self.setupPreviewLayer()
            }
            
            // Setup output
            setupOutput()
            
            // commit configuration: ë‹¨ì¼ atomic ì—…ë°ì´íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ìº¡ì²˜ ì„¸ì…˜ì˜ êµ¬ì„±ì— ëŒ€í•œ í•˜ë‚˜ ì´ìƒì˜ ë³€ê²½ ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤.
            self.captureSession.commitConfiguration()
            // ìº¡ì²˜ ì„¸ì…˜ ì‹¤í–‰
            captureSession.startRunning()
        }
    }
    
    func setupInputs() {
        // í›„ë©´(back) ë° ì „ë©´(front) ì¹´ë©”ë¼
        if let backCamera = AVCaptureDevice.default(.builtInWideAngleCamera, for: .video, position: .back),
           let frontCamera = AVCaptureDevice.default(.builtInWideAngleCamera, for: .video, position: .front) {
            self.backCamera = backCamera
            self.frontCamera = frontCamera
        } else {
            fatalError("No cameras.")
        }
        
        // ì´ì œ ê¸°ê¸°ë¡œë¶€í„° ì…ë ¥ ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
        guard let backInput = try? AVCaptureDeviceInput(device: self.backCamera) else {
            fatalError("could not create input device from back camera")
        }
        self.backInput = backInput
        if !captureSession.canAddInput(self.backInput) {
            fatalError("could not add back camera input to capture session")
        }
        
        guard let frontInput = try? AVCaptureDeviceInput(device: self.frontCamera) else {
            fatalError("could not create input device from front camera")
        }
        self.frontInput = frontInput
        if !captureSession.canAddInput(self.frontInput) {
            fatalError("could not add front camera input to capture session")
        }
        
        // í›„ë©´ ì¹´ë©”ë¼ ì…ë ¥ì„ ì„¸ì…˜ì— ì—°ê²°í•©ë‹ˆë‹¤.
        captureSession.addInput(backInput)
    }
    
    func setupPreviewLayer() {
        previewLayer = AVCaptureVideoPreviewLayer(session: captureSession)
        view.layer.insertSublayer(previewLayer, below: switchCameraButton.layer)
        previewLayer.frame = self.view.frame
    }
    
    func setupOutput() {
        videoOutput = AVCaptureVideoDataOutput()
        let videoQueue = DispatchQueue(label: "videoQueue", qos: .userInteractive)
        videoOutput.setSampleBufferDelegate(self, queue: videoQueue)
        
        if captureSession.canAddOutput(videoOutput) {
            captureSession.addOutput(videoOutput)
        } else {
            fatalError("could not add video output")
        }
        
        // ë°©í–¥ì„ í¬íŠ¸ë ˆì´íŠ¸(ì„¸ë¡œ)ë¡œ ì„¤ì •
        videoOutput.connections.first?.videoOrientation = .portrait
    }
    
    func switchCameraInput() {
        // ìŠ¤ìœ„ì¹˜ë˜ëŠ” ë™ì•ˆ ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ìŠ¤íŒ¸ì²˜ëŸ¼ ì—°íƒ€í•˜ì§€ ëª»í•˜ë„ë¡ í•©ë‹ˆë‹¤.
        // ì‚¬ìš©ìì—ê²ŒëŠ” ì¬ë¯¸ê°€ ìˆì§€ë§Œ ì„±ëŠ¥ì—ëŠ” ì¬ë¯¸ê°€ ì—†ìŠµë‹ˆë‹¤.
        switchCameraButton.isUserInteractionEnabled = false
        
        // input ì¬ì„¤ì •
        captureSession.beginConfiguration()
        
        if isBackCameraOn {
            captureSession.removeInput(backInput)
            captureSession.addInput(frontInput)
            isBackCameraOn = false
        } else {
            captureSession.removeInput(frontInput)
            captureSession.addInput(backInput)
            isBackCameraOn = true
        }
        
        // ë‹¤ì‹œ ë°©í–¥ì„ í¬íŠ¸ë ˆì´íŠ¸(ì„¸ë¡œ)ë¡œ ì„¤ì •
        videoOutput.connections.first?.videoOrientation = .portrait
        
        // ì „ë©´ ì¹´ë©”ë¼ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ë¯¸ëŸ¬ë§
        videoOutput.connections.first?.isVideoMirrored = !isBackCameraOn
        
        // commit config
        captureSession.commitConfiguration()
        
        // ë‹¤ì‹œ ì¹´ë©”ë¼ ë²„íŠ¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.
        switchCameraButton.isUserInteractionEnabled = true
    }
    
    // MARK: - Actions
    @objc func captureImage(_ sender: UIButton?){
        isTakePicture = true
    }
    
    @objc func switchCamera(_ sender: UIButton?){
        switchCameraInput()
    }
}

extension ViewController: AVCaptureVideoDataOutputSampleBufferDelegate {
    func captureOutput(_ output: AVCaptureOutput, didOutput sampleBuffer: CMSampleBuffer, from connection: AVCaptureConnection) {
        if !isTakePicture {
            return // ì´ë¯¸ì§€ ë²„í¼ë¡œ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.
        }
        
        // ìƒ˜í”Œ ë²„í¼ì—ì„œ CVImageBufferë¥¼ ê°€ì ¸ì˜¤ê¸°
        guard let cvBuffer = CMSampleBufferGetImageBuffer(sampleBuffer) else {
            return
        }
        
        // CVImageBufferì—ì„œ CIImageë¥¼ ê°€ì ¸ì˜¤ê¸°
        let ciImage = CIImage(cvImageBuffer: cvBuffer)
        
        // CIIImageë¥¼ UIImageë¡œ ë³€í™˜
        let uiImage = UIImage(ciImage: ciImage)
        
        // ì´ë¯¸ì§€ í‘œì‹œ (UI ì˜ì—­)
        DispatchQueue.main.async {
            self.capturedImageView.image = uiImage
            self.isTakePicture = false
        }
    }
}

```
