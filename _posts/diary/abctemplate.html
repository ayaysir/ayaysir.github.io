<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.min.js"
    id="abcjs-plugin-js"></script>

  <script>
    var objsArr = []
    var abcArr = []
    var synthArr = []

    const onDomReady = () => {
      // 여기에 실행할 코드
      // 1) pre > code.language-abc 모두 순회
      const selectors = [
        'code.language-abc',
        'code.abc',
        'code.language-abcjs',
        'pre > code.language-abc'
      ];
      document.querySelectorAll(selectors.join(', ')).forEach((codeEl, idx) => {
        // ABC 코드 추출
        const abc = codeEl.textContent;

        // pre 요소 가져오기
        const pre = codeEl.parentElement;

        // notation/midi id 구성
        const notationId = `abcjs-notation-${idx}`;
        const midiId = `abcjs-audio-${idx}`;

        // pre 를 대체할 HTML
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <div id="${notationId}"></div>
          <div id="${midiId}"></div>
        `;

        // pre 삭제 & 새 요소 삽입
        pre.replaceWith(wrapper);

        // ---------------------------
        //  ABCJS 렌더링
        // ---------------------------

        // 악보(Notation)
        var visualIds = [notationId];
        var params = { responsive: 'resize', clickListener: clickListener };
        var abcString = abc;

        var visualObjs = ABCJS.renderAbc(visualIds, abcString, params);
        objsArr[idx] = visualObjs
        abcArr[idx] = abc

        // 오디오 플레이어 초기화
        initSynth(idx, visualObjs)
      });
      document.querySelectorAll('.abcjs-css-warning').forEach(el => el.remove());

      // Transpose 패널
      document.querySelectorAll('div.abcjs-inline-audio').forEach((container, idx) => {
        const parent = container.parentElement;
        if (!parent) return;  
        parent.insertAdjacentHTML(
          'afterend',
          `<label><span style="font-size: 10px; font-weight: bold;">Transpose:</span> 
            <input id="transpose-${idx}" 
            data-idx="${idx}" 
            class="transpose-half-steps" 
            type="number" 
            onchange="redraw(${idx}, this.value);"
            min="-12" 
            max="12" 
            step="1" 
            value="0">
            <button style="width: 30px;" onclick="changeTransposeValue(${idx}, -1);">-</button>
            <button style="width: 30px;" onclick="changeTransposeValue(${idx}, 1);">+</button>
          </label>`
        );
      });

      // === css 강제주입 ===

      const style = document.createElement('style');
      style.type = 'text/css';
      style.textContent = `
          /* Some basic CSS to make the Audio controls in abcjs presentable. */

          .abcjs-inline-audio {
            height: 26px;
            padding: 0 5px;
            border-radius: 3px;
            background-color: #424242;
            display: flex;
            align-items: center;
            box-sizing: border-box;
          }

          .abcjs-inline-audio.abcjs-disabled {
            opacity: 0.5;
          }

          .abcjs-inline-audio .abcjs-btn {
            display: block;
            width: 28px;
            height: 34px;
            margin-right: 2px;
            padding: 7px 4px;

            background: none !important;
            border: 1px solid transparent;
            box-sizing: border-box;
            line-height: 1;
          }

          .abcjs-btn g {
            fill: #f4f4f4;
            stroke: #f4f4f4;
          }

          .abcjs-inline-audio .abcjs-btn:hover g {
            fill: #cccccc;
            stroke: #cccccc;
          }

          .abcjs-inline-audio .abcjs-midi-selection.abcjs-pushed {
            border: 1px solid #cccccc;
            background-color: #666666;
            box-sizing: border-box;
          }

          .abcjs-inline-audio .abcjs-midi-loop.abcjs-pushed {
            border: 1px solid #cccccc;
            background-color: #666666;
            box-sizing: border-box;
          }

          .abcjs-inline-audio .abcjs-midi-reset.abcjs-pushed {
            border: 1px solid #cccccc;
            background-color: #666666;
            box-sizing: border-box;
          }

          .abcjs-inline-audio .abcjs-midi-start .abcjs-pause-svg {
            display: none;
          }

          .abcjs-inline-audio .abcjs-midi-start .abcjs-loading-svg {
            display: none;
          }

          .abcjs-inline-audio .abcjs-midi-start.abcjs-pushed .abcjs-play-svg {
            display: none;
          }

          .abcjs-inline-audio .abcjs-midi-start.abcjs-loading .abcjs-play-svg {
            display: none;
          }

          .abcjs-inline-audio .abcjs-midi-start.abcjs-pushed .abcjs-pause-svg {
            display: block;
          }

          .abcjs-inline-audio .abcjs-midi-progress-background {
            background-color: #424242;
            height: 10px;
            border-radius: 5px;
            border: 2px solid #cccccc;
            margin: 0 8px 0 15px;
            position: relative;
            flex: 1;
            padding: 0;
            box-sizing: border-box;
          }

          .abcjs-inline-audio .abcjs-midi-progress-indicator {
            width: 20px;
            margin-left: -10px; /* half of the width */
            height: 14px;
            background-color: #f4f4f4;
            position: absolute;
            display: inline-block;
            border-radius: 6px;
            top: -4px;
            left: 0;
            box-sizing: border-box;
          }

          .abcjs-inline-audio .abcjs-midi-clock {
            margin-left: 4px;
            margin-top: 1px;
            margin-right: 2px;
            display: inline-block;
            font-family: sans-serif;
            font-size: 16px;
            box-sizing: border-box;
            color: #f4f4f4;
          }

          .abcjs-inline-audio .abcjs-tempo-wrapper {
            font-size: 10px;
            color: #f4f4f4;
            box-sizing: border-box;
            display: flex;
            align-items: center;
          }

          .abcjs-inline-audio .abcjs-midi-tempo {
            border-radius: 2px;
            border: none;
            margin: 0 2px 0 4px;
            width: 42px;
            padding-left: 2px;
            box-sizing: border-box;
          }

          .abcjs-inline-audio .abcjs-loading .abcjs-loading-svg {
            display: inherit;
          }

          .abcjs-inline-audio .abcjs-loading {
            outline: none;
            animation-name: abcjs-spin;
            animation-duration: 1s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;

          }
          .abcjs-inline-audio .abcjs-loading-svg circle {
            stroke: #f4f4f4;
          }

          @keyframes abcjs-spin {
            from {transform:rotate(0deg);}
            to {transform:rotate(360deg);}
          }

          /* Adding the class "abcjs-large" will make the control easier on a touch device. */
          .abcjs-large .abcjs-inline-audio {
            height: 52px;
          }
          .abcjs-large .abcjs-btn {
            width: 56px;
            height: 52px;
            font-size: 28px;
            padding: 6px 8px;
          }
          .abcjs-large .abcjs-midi-progress-background {
            height: 20px;
            border: 4px solid #cccccc;
          }
          .abcjs-large .abcjs-midi-progress-indicator {
            height: 28px;
            top: -8px;
            width: 40px;
          }
          .abcjs-large .abcjs-midi-clock {
            font-size: 32px;
            margin-right: 10px;
            margin-left: 10px;
            margin-top: -1px;
          }
          .abcjs-large .abcjs-midi-tempo {
            font-size: 20px;
            width: 50px;
          }
          .abcjs-large .abcjs-tempo-wrapper {
            font-size: 20px;
          }

          .abcjs-css-warning {
            display: none;
          }
      `;

      document.head.appendChild(style);
    };
    /*
    - code class 'pre > code.language-abc' 를 순회해서 code.textContent만 저장
    - code 태그 위의 pre는 삭제하고 그 부분을 
       <div id="abcjs-notation-0"></div>
       <div id="abcjs-midi-0"><div>
      로 대체(인덱스에 따라 0부터 증가)
    - 아래 코드를 실행
    */
    document.addEventListener("DOMContentLoaded", onDomReady);


    /// 커서 이동 관련 함수
    function CursorControl(selector) {
      var self = this;

      self.onStart = function () {
        var svg = document.querySelector("#" + selector + " svg");
        var cursor = document.createElementNS("http://www.w3.org/2000/svg", "line");
        cursor.setAttribute("class", "abcjs-cursor");
        cursor.setAttributeNS(null, 'x1', 0);
        cursor.setAttributeNS(null, 'y1', 0);
        cursor.setAttributeNS(null, 'x2', 0);
        cursor.setAttributeNS(null, 'y2', 0);
        svg.appendChild(cursor);

      };
      self.beatSubdivisions = 2;
      self.onEvent = function (ev) {
        if (ev.measureStart && ev.left === null)
          return; // this was the second part of a tie across a measure line. Just ignore it.

        var lastSelection = document.querySelectorAll("#" + selector + " svg .highlight");
        for (var k = 0; k < lastSelection.length; k++)
          lastSelection[k].classList.remove("highlight");

        for (var i = 0; i < ev.elements.length; i++) {
          var note = ev.elements[i];
          for (var j = 0; j < note.length; j++) {
            note[j].classList.add("highlight");
          }
        }

        var cursor = document.querySelector("#" + selector + " svg .abcjs-cursor");
        if (cursor) {
          cursor.setAttribute("x1", ev.left - 2);
          cursor.setAttribute("x2", ev.left - 2);
          cursor.setAttribute("y1", ev.top);
          cursor.setAttribute("y2", ev.top + ev.height);
        }
      };
      self.onFinished = function () {
        var els = document.querySelectorAll("#" + selector + " svg .highlight");
        for (var i = 0; i < els.length; i++) {
          els[i].classList.remove("highlight");
        }
        var cursor = document.querySelector("#" + selector + " svg .abcjs-cursor");
        if (cursor) {
          cursor.setAttribute("x1", 0);
          cursor.setAttribute("x2", 0);
          cursor.setAttribute("y1", 0);
          cursor.setAttribute("y2", 0);
        }
      };
    }

    /// 악보 노트 클릭했을 때 이벤트 리스너
    function clickListener(abcElem, tuneNumber, classes, analysis, drag, mouseEvent) {
      var lastClicked = abcElem.midiPitches;
      if (!lastClicked)
        return;

      ABCJS.synth
        .playEvent(lastClicked, abcElem.midiGraceNotePitches, 1000)
        .then(function (response) {
          console.log("note played");
        }).catch(function (error) {
          console.log("error playing note", error);
        });
    }

    /// Transposed된 경우 악보&플레이어 다시 그리기
    function redraw(idx, transposeValue) {
      const abc = abcArr[idx]
      // re-render visualObj
      objsArr[idx] = ABCJS.renderAbc(`abcjs-notation-${idx}`, abc, {
        visualTranspose: transposeValue,
        responsive: 'resize', 
        clickListener: clickListener 
      });

      // re-set tune stored in SynthController
      synthArr.forEach(el => {el.pause()})
      initSynth(idx, objsArr[idx], transposeValue)
    }

    /// 오디오 플레이어 초기화
    function initSynth(idx, visualObjs, transpose = 0) {
        var cursorControl = new CursorControl(`abcjs-notation-${idx}`, null);
        var synthControl = new ABCJS.synth.SynthController();
        var el = document.getElementById(`abcjs-audio-${idx}`);
        synthControl.load(el, cursorControl, {
          displayRestart: true,
          displayPlay: true,
          displayProgress: true
        });
        synthControl.disable(true);
        synthArr[idx] = synthControl
        var midiBuffer = new ABCJS.synth.CreateSynth();

        midiBuffer.init({
          visualObj: visualObjs[0],
          options: { responsive: 'resize' }
        }).then(() => {
          if (synthControl) {
            synthControl.setTune(visualObjs[0], false, { midiTranspose: transpose }).catch(error => {
              console.warn("Audio problem:", error);
            });
          }
        }).catch(error => {
          console.warn("Audio problem:", error);
        });
    }

    function changeTransposeValue(idx, addValue = 1) {
      var selector = document.querySelector(`#transpose-${idx}`)
      var addValue = parseInt(addValue)
      let oldValue = parseInt(selector.value)
      selector.value = oldValue + addValue
      redraw(idx, selector.value)
    }
  </script>

  <!-- <code class="abc">X: 1
T:
Q: 1/4=120
M: C
L: 1/8
R: 예제2-B
K: C
"C" E^DEG z4 | "C7" z ^FGd c_BG^G | "F" A^GAc z4 | "F#dim" zD (3_E^FA dcBA | "C/G" G8 ||
w: ~◯ ~도 ~◯ ~◯ | 앞 ~◯ ~앞 ~◯ ~◯ ~◯ ~지 | ~◯ ~도 ~◯ ~◯ | ~앞 ~◯ ~◯ ~◯ ~앞 ~◯ 지 ~◯ | ~◯</code> -->

  <code class="abc">X: 1
T:
Q: 1/4=120
\%\%staves [(1 2) (3 4)]
M: 4/4
L: 1/8
R: 걸림음 2
K: C
V:1 treble
e4- "걸(13th)"e2 "5"d2 | c4- "걸(♭13th)"c2 "5"B2 | A4- "걸(13th)"A2 "5"G2 | F8 ||
V:2 treble
c4 B4- | B2 A2 ^G4 | G2 F2 E4- | E2 D2 ^C2 =C2 ||
w: _ _ | 걸(9th)~ 1 _ | 앞(9th)~ 1 _ | 걸(9th)~ 1 지 7th
V:3 bass
G4 F4 | E4 D4 | C4 _B,4 | A,8 ||
V:4 bass
C4 G,4 | A,4 E,4 | F,4 C,4 | D,8 ||</code>
</body>

</html>